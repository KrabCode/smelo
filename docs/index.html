<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>≈†MELO.CZ</title>
    <link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        #chartDiv {
            width: 100%;
            max-width: 1200px;
            min-width: 400px;
            height: 420px;
            margin: 0 auto;
        }
        #graphSpinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            width: 100%;
        }
        #graphSpinner .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #4E79A7;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .google-visualization-tooltip {
            background: #222 !important;
            border: 1px solid #444 !important;
            border-radius: 6px !important;
            padding: 0 !important;
            text-align: left !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5) !important;
            pointer-events: none;
        }
        .tt { font-family: 'Segoe UI', Arial, sans-serif; font-size: 12px; color: #ddd; padding: 8px 12px; min-width: 180px; text-align: left; }
        .tt-header { font-weight: bold; color: #fff; margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid #444; text-align: left; }
        .tt-row { display: flex; align-items: center; padding: 2px 0; font-family: monospace; font-size: 12px; }
        .tt-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; flex-shrink: 0; }
        .tt-name { flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: left; }
        .tt-val { margin-left: 8px; white-space: nowrap; text-align: right; min-width: 30px; }
        .tt-delta { margin-left: 6px; white-space: nowrap; color: #888; text-align: right; min-width: 40px; }
        .tt-delta.pos { color: #4ade80; }
        .tt-delta.neg { color: #f87171; }
        #statsTableDiv {
            max-width: 700px;
            margin: 10px auto 30px;
            padding: 0 12px;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        #statsTableDiv table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            color: #ccc;
        }
        #statsTableDiv th {
            color: #888;
            font-weight: normal;
            text-align: right;
            padding: 4px 8px;
            border-bottom: 1px solid #333;
            font-size: 0.85em;
            cursor: pointer;
            user-select: none;
        }
        #statsTableDiv th:hover { color: #ccc; }
        #statsTableDiv th:first-child { text-align: left; }
        #statsTableDiv td {
            padding: 3px 8px;
            text-align: right;
            border-bottom: 1px solid #222;
        }
        #statsTableDiv td:first-child { text-align: left; }
        #statsTableDiv tr[data-player] { cursor: pointer; }
        #statsTableDiv tr[data-player]:hover { background: #2a2a2a; }
        #statsTableDiv tr[data-player].selected { background: #333; }
        #statsTableDiv .val-pos { color: #4ade80; }
        #statsTableDiv .val-neg { color: #f87171; }
        .range-btn {
            background: #333; color: #aaa; border: 1px solid #555; padding: 4px 14px;
            font-size: 0.85em; cursor: pointer; border-radius: 4px; margin: 0 3px;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .range-btn.active { background: #555; color: #eee; border-color: #888; }
        .range-btn:hover { background: #444; }
    </style>
</head>
<body>
<div style="text-align:center;">
  <h1 class="smelotitle"><a href="https://smelo.cz">≈†MELO.CZ</a></h1>
  <hr>
  <h2 class="collapsible-title"><span class="arrow">‚ñº</span>V√Ωsledky</h2>
  <div class="collapsible-section">
    <div id="rangeToggle" style="margin:12px 0 4px;display:none;">
      <button id="btnHalf" class="range-btn active">P≈Ølrok</button>
      <button id="btnAll" class="range-btn">V≈°e</button>
    </div>
    <div id="graphSpinner"><div class="spinner"></div></div>
    <div id="chartDiv" style="visibility:hidden;"></div>
    <div id="statsTableDiv"></div>
  </div>
  <hr>
  <h2 class="collapsible-title"><span class="arrow">‚ñº</span>moje cesta</h2>
  <div class="collapsible-section">
    <div style="display:flex; justify-content:center;">
      <p style="text-align:left; max-width:600px;">
        üÉè‚ú® Jednoho veƒçera jsem sedƒõl u pokerov√©ho stolu s podez≈ôel√Ωmi lidmi.<br><br>
        Karty byly proti mnƒõ, soupe≈ô si tahal z ruk√°vu ≈æetony. üé≤<br>
        Tu noc jsem prohr√°l. üòÖ<br><br>
        Ale nauƒçil jsem se nƒõco z√°sadn√≠ho: üí°<br>
        V pokeru ‚Äì i v ≈æivotƒõ ‚Äì nejv√≠c vyhr√°v√°≈°, kdy≈æ oh√Ωb√°≈° pravidla. üîÑ<br><br>
        Proƒç hr√°t f√©r, kdy≈æ m≈Ø≈æe≈° hr√°t chyt≈ôe? üß†<br><br>
        Uvƒõdomil jsem si, ≈æe √∫spƒõch nen√≠ o ≈°tƒõst√≠ üçÄ - ≈æe ≈°tƒõst√≠ƒçku se mus√≠ j√≠t naproti. üö∂‚Äç‚ôÇÔ∏è<br>
        ≈†mel v≈ædy a v≈°ude üïµÔ∏è‚Äç‚ôÇÔ∏è a sleduj, jak se ti otev√≠raj√≠ dve≈ôe. üö™<br><br>
        ≈Ωivot je hra. Play to win. ‚ô†Ô∏èüí™<br><br>
        ≈†mel√≠m, tedy jsem. üòé
        <br>
      </p>
    </div>
  </div>
  <hr>
  <h2 class="collapsible-title"><span class="arrow">‚ñº</span>≈†melop≈ô√≠bƒõhy</h2>
  <div class="collapsible-section">
    <div style="display:flex; justify-content:center; margin:40px 0; background: none;">
      <iframe src="testimonials.html" style="width:100%; max-width:548px; height:380px; border:none; border-radius:12px; background: none;"></iframe>
    </div>
  </div>
  <hr>
  <h2 class="collapsible-title"><span class="arrow">‚ñº</span>≈†melkarty</h2>
  <div class="collapsible-section">
    <div style="max-width:400px;margin:auto;">
      <div style="display:flex;flex-direction:column;gap:24px;">
        <img src="assets/Skulls.png" alt="Kr√°sn√° ruka!" class="smelkarta" />
        <img src="assets/Smutek.png" alt="Smutek" class="smelkarta" />
        <img src="assets/Blindy.png" alt="Blindy" class="smelkarta" />
        <img src="assets/Tank.png" alt="Tank" class="smelkarta" />
        <img src="assets/Uspokojsa.png" alt="Ucpokorca" class="smelkarta" />
        <img src="assets/nepracuje_at_smeli.png" alt="Frame 12" class="smelkarta" />
        <img src="assets/nesmeli_at_neji.png" alt="smelo_7" class="smelkarta" />
        <img src="assets/nesmelite_smelte.png" alt="Frame 18" class="smelkarta" />
        <img src="assets/≈†melwood.png" alt="≈†melwood" class="smelkarta" />
        <img src="assets/lotr.png" alt="LOTR" class="smelkarta" />
        <img src="assets/≈†melparte.png" alt="≈†melparte" class="smelkarta" />
        <img src="assets/≈†melbank.png" alt="≈†melbank" class="smelkarta" />
        <img src="assets/zizka.png" alt="Frame 11" class="smelkarta" />
        <img src="assets/nesoudime.png" alt="Nesoudime" class="smelkarta" />
        <img src="assets/radeji_smelo.png" alt="Frame 10" class="smelkarta" />
        <img src="assets/posmeleni.png" alt="Frame 13" class="smelkarta" />
        <img src="assets/dokonale_smelo.png" alt="Frame 19" class="smelkarta" />
        <img src="assets/neleni_smeleni.png" alt="Frame 23" class="smelkarta" />
        <img src="assets/smelo_je_zelezna_kosile.png" alt="Frame 8" class="smelkarta" />
        <img src="assets/na_starem_smelidle.png" alt="Babicka" class="smelkarta" />
        <img src="assets/tiche_smelo.png" alt="Frame 9" class="smelkarta" />
        <img src="assets/manon.png" alt="Manon" class="smelkarta" />
        <img src="assets/Probl√©m t≈ô√≠ ≈°meles.png" alt="Probl√©m t≈ô√≠ ≈°meles" class="smelkarta" />
        <img src="assets/samotari.png" alt="Samot√°≈ôi_2" class="smelkarta" />
        <img src="assets/tolik_zetonu_jsi_nemel.jpg" alt="smelo_1_fade" class="smelkarta" />
        <img src="assets/neni_dulezite_vyhrat.jpg" alt="smelo_2_fade" class="smelkarta" />
        <img src="assets/smelit_definice.jpg" alt="smelo_3" class="smelkarta" />
        <img src="assets/starci.png" alt="starci" class="smelkarta" />
        <img src="assets/mluviti_stribro_smeliti_zlato.png" alt="Frame 3" class="smelkarta" />
        <img src="assets/live_laugh_smelo.png" alt="Frame 5" class="smelkarta" />
      </div>
    </div>
  </div>
</div>
<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTAYSlBiWTAJ_th0XEzDk9fthNQBrF88_FdBry3l8l9IrcGuopvFoBzIY4Byb5yfTE0U-LyqGkmZxkX/pub?gid=0&single=true&output=csv';
    const PLAYER_MIN_SESSIONS = 2;
    const COLORS = [
        "#E15759","#4E79A7","#F28E2B","#76B7B2","#59A14F","#EDC948",
        "#B07AA1","#FF9DA7","#9C755F","#BAB0AC","#1F77B4","#AEC7E8",
        "#FF7F0E","#FFBB78","#2CA02C","#98DF8A","#D62728","#FF9896",
        "#9467BD","#C5B0D5","#8C564B","#C49C94","#E377C2","#F7B6D2",
        "#7F7F7F","#C7C7C7","#BCBD22","#DBDB8D","#17BECF","#9EDAE5",
        "#393b79","#5254a3","#6b6ecf","#9c9ede","#637939","#8ca252",
        "#b5cf6b","#cedb9c","#8c6d31","#bd9e39","#e7ba52","#e7cb94",
        "#843c39","#ad494a","#d6616b","#e7969c","#7b4173","#a55194",
        "#ce6dbd","#de9ed6","#1b9e77","#d95f02"
    ];
    let chart = null, chartData = null, playerNames = [], playerColors = {}, selectedPlayer = '';
    let storedCumulative = null, storedOriginalCells = null, storedSessionLabels = null;
    let rangeMode = 'half'; // 'half' or 'all'
    // Raw parsed data (set once on fetch)
    let rawAllRowsWithDate = null, rawHeaders = null;
    const CACHE_KEY = 'smelo_graph_csv', CACHE_TS_KEY = 'smelo_graph_csv_ts', CACHE_TTL = 3600000;

    function fetchCSV() {
        const cached = localStorage.getItem(CACHE_KEY), cachedTs = localStorage.getItem(CACHE_TS_KEY);
        if (cached && cachedTs && (Date.now() - Number(cachedTs)) < CACHE_TTL) return Promise.resolve(cached);
        return fetch(SHEET_URL).then(r => r.text()).then(csv => {
            try { localStorage.setItem(CACHE_KEY, csv); localStorage.setItem(CACHE_TS_KEY, String(Date.now())); } catch(e) {}
            return csv;
        });
    }

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchAndRender);

    function fetchAndRender() {
        fetchCSV().then(csv => {
            const lines = csv.trim().split('\n');
            rawHeaders = lines[0].split(',');
            const allDataRows = lines.slice(2).map(line => line.split(','));
            rawAllRowsWithDate = allDataRows
                .filter(row => row[1] && row[1].trim() !== '')
                .map(row => {
                    const raw = row[1].trim();
                    let ts = Date.parse(raw);
                    if (isNaN(ts)) {
                        let m = raw.match(/(\d{4}-\d{2}-\d{2})/);
                        if (m) ts = Date.parse(m[1]);
                        else {
                            m = raw.match(/(\d{1,2}\.\d{1,2}\.\d{4})/);
                            if (m) { const p = m[1].split('.'); ts = Date.parse(`${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`); }
                            else {
                                m = raw.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                                if (m) { const p = m[1].split('/'); ts = Date.parse(`${p[2]}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}`); }
                                else ts = NaN;
                            }
                        }
                    }
                    return { row, date: isNaN(ts) ? null : new Date(ts) };
                });
            processAndRender();
            document.getElementById('rangeToggle').style.display = '';
            document.getElementById('graphSpinner').style.display = 'none';
            document.getElementById('chartDiv').style.visibility = 'visible';
        });
    }

    function processAndRender() {
        const allRowsWithDate = rawAllRowsWithDate;
        const headers = rawHeaders;

        const sixMonthsAgo = new Date();
        sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
        const validColumns = headers.map((h, i) => ({ h, i })).filter(x => x.h && x.h.trim() !== '');

        // Filter players: always based on 6-month appearances
        const rowsRecent = allRowsWithDate.filter(x => x.date && x.date >= sixMonthsAgo).map(x => x.row);
        const appearances = validColumns.map(x => {
            let c = 0;
            for (const row of rowsRecent) { const v = row[x.i]; if (v !== undefined && v !== '' && v !== '0' && Number(v) !== 0) c++; }
            return c;
        });
        const filteredColumns = validColumns.filter((_, i) => appearances[i] >= PLAYER_MIN_SESSIONS);
        playerNames = filteredColumns.map(x => x.h);
        playerNames.forEach((name, i) => { playerColors[name] = COLORS[i % COLORS.length]; });

        const allWinnings = allRowsWithDate.map(x => filteredColumns.map(col => x.row[col.i] === '' ? 0 : Number(x.row[col.i])));
        const allOriginalCells = allRowsWithDate.map(x => filteredColumns.map(col => x.row[col.i]));
        const allCumulative = playerNames.map((_, ci) => { let s = 0; return allWinnings.map(row => s += (row[ci] || 0)); });

        let cutoffIndex = 0;
        if (rangeMode === 'half') {
            for (let i = 0; i < allRowsWithDate.length; i++) {
                if (allRowsWithDate[i].date && allRowsWithDate[i].date >= sixMonthsAgo) { cutoffIndex = i; break; }
            }
        }

        const rows = allRowsWithDate.slice(cutoffIndex);
        const cumulative = allCumulative.map(arr => arr.slice(cutoffIndex));
        const originalCells = allOriginalCells.slice(cutoffIndex);

        cumulative.forEach((arr, ci) => {
            let lastIdx = -1;
            for (let i = arr.length - 1; i >= 0; i--) {
                const cell = originalCells[i][ci];
                if (cell !== undefined && cell !== '' && cell !== '0' && Number(cell) !== 0) { lastIdx = i; break; }
            }
            if (lastIdx >= 0 && lastIdx < arr.length - 1) for (let i = lastIdx + 1; i < arr.length; i++) arr[i] = null;
        });
        cumulative.forEach((arr) => {
            let firstIdx = -1;
            for (let i = 0; i < arr.length; i++) { if (arr[i] != null && arr[i] !== 0) { firstIdx = i; break; } }
            if (firstIdx > 0) for (let i = 0; i < firstIdx; i++) arr[i] = null;
        });

        const sessionLabels = rows.map(x => x.row[1]
            .replace(/Mon/g,'Po').replace(/Tue/g,'√öt').replace(/Wed/g,'St')
            .replace(/Thu/g,'ƒåt').replace(/Fri/g,'P√°').replace(/Sat/g,'So').replace(/Sun/g,'Ne'));

        storedCumulative = cumulative;
        storedOriginalCells = originalCells;
        storedSessionLabels = sessionLabels;

        drawChart();
        drawStatsChart();
    }

    // Range toggle
    document.getElementById('btnHalf').addEventListener('click', () => {
        if (rangeMode === 'half') return;
        rangeMode = 'half';
        document.getElementById('btnHalf').classList.add('active');
        document.getElementById('btnAll').classList.remove('active');
        processAndRender();
    });
    document.getElementById('btnAll').addEventListener('click', () => {
        if (rangeMode === 'all') return;
        rangeMode = 'all';
        document.getElementById('btnAll').classList.add('active');
        document.getElementById('btnHalf').classList.remove('active');
        processAndRender();
    });

    function buildTooltip(rowIdx) {
        const date = storedSessionLabels[rowIdx];
        const entries = playerNames.map((name, ci) => {
            const cell = storedOriginalCells[rowIdx][ci];
            const delta = (cell !== undefined && cell !== '' && cell !== '0') ? Number(cell) : 0;
            if (delta === 0) return null;
            return { name: name.split('/')[0].trim(), val: storedCumulative[ci][rowIdx], delta, color: playerColors[name] };
        }).filter(Boolean).sort((a, b) => b.delta - a.delta);
        let html = `<div class="tt"><div class="tt-header">${date}</div>`;
        entries.forEach(e => {
            const sign = e.delta > 0 ? '+' : '';
            const cls = e.delta > 0 ? 'pos' : e.delta < 0 ? 'neg' : '';
            html += `<div class="tt-row"><span class="tt-dot" style="background:${e.color}"></span><span class="tt-name">${e.name}</span><span class="tt-val">${e.val}</span><span class="tt-delta ${cls}">(${sign}${e.delta})</span></div>`;
        });
        return html + '</div>';
    }

    function drawChart() {
        if (!storedCumulative) return;
        const cumulative = storedCumulative;
        const originalCells = storedOriginalCells;
        const sessionLabels = storedSessionLabels;

        // Build DataTable fresh each draw (needed for per-point styles)
        chartData = new google.visualization.DataTable();
        chartData.addColumn('string', 'Datum');
        playerNames.forEach(name => {
            chartData.addColumn('number', name);
            chartData.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });
            chartData.addColumn({ type: 'string', role: 'style' });
        });
        for (let i = 0; i < sessionLabels.length; i++) {
            const tt = buildTooltip(i);
            const row = [sessionLabels[i]];
            playerNames.forEach((name, ci) => {
                row.push(cumulative[ci][i]);
                row.push(tt);
                // Show point only if this player participated this session
                const cell = originalCells[i][ci];
                const played = cell !== undefined && cell !== '' && cell !== '0' && Number(cell) !== 0;
                if (selectedPlayer && name === selectedPlayer) {
                    row.push(played ? 'point {size: 5; visible: true;}' : 'point {size: 0; visible: false;}');
                } else {
                    row.push(null);
                }
            });
            chartData.addRow(row);
        }

        const mute = hex => {
            const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            const bg = 34; // ~#222 background
            const mix = (c) => Math.round(bg + (c - bg) * 0.25);
            return '#' + [r,g,b].map(c => mix(c).toString(16).padStart(2,'0')).join('');
        };
        const series = {};
        playerNames.forEach((name, i) => {
            const color = playerColors[name];
            if (selectedPlayer && name === selectedPlayer) series[i] = { color, lineWidth: 3, pointSize: 0, visibleInLegend: true };
            else if (selectedPlayer) series[i] = { color: mute(color), lineWidth: 1, pointSize: 0, visibleInLegend: false };
            else series[i] = { color: mute(color), lineWidth: 2, pointSize: 0, visibleInLegend: true };
        });
        const options = {
            title: 'Kumulativn√≠ ≈°melo', titleTextStyle: { fontSize: 14, color: '#eee' },
            legend: 'none', interpolateNulls: false, dataOpacity: 1.0, series,
            hAxis: { textStyle: { fontSize: 10, color: '#aaa' }, slantedText: true, slantedTextAngle: 45, gridlines: { color: '#333' }, baselineColor: '#444' },
            vAxis: { title: 'po≈°mel / v√Ω≈°mel', titleTextStyle: { color: '#aaa', italic: false }, textStyle: { color: '#aaa' }, gridlines: { color: '#333' }, baselineColor: '#888', format: 'short' },
            chartArea: { left: 60, top: 40, right: 20, bottom: 80, width: '100%', height: '100%', backgroundColor: 'transparent' },
            tooltip: { isHtml: true, trigger: 'both' },
            explorer: { actions: ['dragToZoom', 'rightClickToReset'], axis: 'horizontal', keepInBounds: true, maxZoomIn: 0.1 },
            backgroundColor: 'transparent'
        };
        if (!chart) chart = new google.visualization.LineChart(document.getElementById('chartDiv'));
        chart.draw(chartData, options);
    }

    let statsSortCol = 'total', statsSortAsc = false, statsData = null;

    function computeStats() {
        if (!storedOriginalCells || !playerNames.length) return [];
        const oc = storedOriginalCells;
        return playerNames.map((name, ci) => {
            const sessions = [];
            for (let i = 0; i < oc.length; i++) {
                const cell = oc[i][ci];
                if (cell !== undefined && cell !== '' && cell !== '0' && Number(cell) !== 0) sessions.push(Number(cell));
            }
            const cum = storedCumulative[ci];
            let total = 0;
            for (let j = cum.length - 1; j >= 0; j--) { if (cum[j] != null) { total = cum[j]; break; } }
            if (!sessions.length) return { name: name.split('/')[0].trim(), fullName: name, avg: 0, best: 0, worst: 0, total, games: 0, color: playerColors[name] };
            return {
                name: name.split('/')[0].trim(),
                fullName: name,
                avg: Math.round(sessions.reduce((a, b) => a + b, 0) / sessions.length),
                best: Math.max(...sessions),
                worst: Math.min(...sessions),
                total,
                games: sessions.length,
                color: playerColors[name]
            };
        });
    }

    function drawStatsChart() {
        statsData = computeStats();
        renderStatsTable();
    }

    function renderStatsTable() {
        if (!statsData) return;
        const sorted = [...statsData].sort((a, b) => {
            const av = statsSortCol === 'name' ? a.name : a[statsSortCol];
            const bv = statsSortCol === 'name' ? b.name : b[statsSortCol];
            if (statsSortCol === 'name') return statsSortAsc ? av.localeCompare(bv, 'cs') : bv.localeCompare(av, 'cs');
            return statsSortAsc ? av - bv : bv - av;
        });

        const arrow = col => statsSortCol === col ? (statsSortAsc ? ' ‚ñ≤' : ' ‚ñº') : '';
        const c = v => v > 0 ? 'val-pos' : v < 0 ? 'val-neg' : '';
        const f = v => v > 0 ? `+${v}` : `${v}`;
        let html = `<table><tr><th data-col="name">Hr√°ƒç${arrow('name')}</th><th data-col="total">Kumulativn√≠ ≈°melo${arrow('total')}</th><th data-col="games">Poƒçet her${arrow('games')}</th><th data-col="avg">Pr≈Ømƒõr za hru${arrow('avg')}</th><th data-col="best">Nejvƒõt≈°√≠ v√Ωhra${arrow('best')}</th><th data-col="worst">Nejvƒõt≈°√≠ prohra${arrow('worst')}</th></tr>`;
        sorted.forEach(s => {
            const sel = selectedPlayer === s.fullName ? ' class="selected"' : '';
            html += `<tr data-player="${s.fullName}"${sel}>` +
                `<td><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${s.color};margin-right:6px;vertical-align:middle;"></span>${s.name}</td>` +
                `<td class="${c(s.total)}">${f(s.total)}</td>` +
                `<td>${s.games}</td>` +
                `<td class="${c(s.avg)}">${f(s.avg)}</td>` +
                `<td class="${c(s.best)}">${f(s.best)}</td>` +
                `<td class="${c(s.worst)}">${f(s.worst)}</td>` +
                `</tr>`;
        });
        html += '</table>';
        const div = document.getElementById('statsTableDiv');
        div.innerHTML = html;
        div.querySelectorAll('th').forEach(th => {
            th.addEventListener('click', () => {
                const col = th.dataset.col;
                if (statsSortCol === col) statsSortAsc = !statsSortAsc;
                else { statsSortCol = col; statsSortAsc = col === 'worst'; }
                renderStatsTable();
            });
        });
        div.querySelectorAll('tr[data-player]').forEach(tr => {
            tr.addEventListener('click', () => {
                const player = tr.dataset.player;
                selectedPlayer = selectedPlayer === player ? '' : player;
                drawChart();
                renderStatsTable();
            });
        });
    }


    window.addEventListener('resize', () => { if (storedCumulative) drawChart(); });
</script>
</div>
</body>
</html>
<script>
// Collapsible sections logic
  document.addEventListener('DOMContentLoaded', function() {
    const titles = document.querySelectorAll('.collapsible-title');
    titles.forEach(function(title) {
      const arrow = title.querySelector('.arrow');
      const section = title.nextElementSibling;
      title.setAttribute('aria-expanded', 'true');
      title.setAttribute('tabindex', '0');
      title.setAttribute('role', 'button');
      title.addEventListener('click', function() {
        const isCollapsed = section.classList.toggle('collapsed-section');
        title.setAttribute('aria-expanded', !isCollapsed);
        arrow.style.transform = isCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
      });
      title.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          title.click();
        }
      });
    });
  });
</script>

