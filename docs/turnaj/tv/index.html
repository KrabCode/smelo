<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blind Tracker – SMELO.CZ</title>
    <link rel="icon" type="image/x-icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../base.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        body { min-height: 100vh; }

        /* Header bar */
        .tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
        }
        .tracker-header a { text-decoration: none; font-size: 0.95em; }
        .tracker-header .stats {
            font-size: 0.95em;
            color: var(--text-secondary);
        }
        .tracker-header .stats span { color: var(--accent); font-weight: bold; }

        /* Main display */
        .display { text-align: center; padding: 24px 20px 12px; }

        .level-label {
            font-family: 'Staatliches', sans-serif;
            font-size: 1.4em;
            letter-spacing: 3px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .timer {
            font-family: 'Staatliches', sans-serif;
            font-size: clamp(4rem, 15vw, 10rem);
            letter-spacing: 0.05em;
            color: var(--text);
            line-height: 1;
            margin: 8px 0;
        }
        .timer.warning { color: var(--red); }
        .timer.paused { opacity: 0.5; }

        /* Progress bar */
        .progress-wrap {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.2s linear;
        }

        /* Blinds display */
        .blinds-label {
            font-size: 0.85em;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-top: 8px;
        }
        .blinds-current {
            font-family: 'Staatliches', sans-serif;
            font-size: clamp(2.5rem, 8vw, 5rem);
            color: var(--accent);
            letter-spacing: 3px;
            margin: 8px 0;
        }
        .blinds-sub {
            font-family: 'Staatliches', sans-serif;
            font-size: clamp(1.2rem, 4vw, 2rem);
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        .next-level {
            margin-top: 16px;
            font-size: 1em;
            color: var(--text-muted);
        }
        .next-level span { color: var(--text-secondary); }

        /* Blind structure table */
        .structure-wrap {
            max-width: 600px;
            margin: 24px auto;
            padding: 0 20px;
        }
        .structure-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .structure-table th {
            color: var(--text-muted);
            font-weight: 500;
            text-align: center;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85em;
            letter-spacing: 1px;
        }
        .structure-table td {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            color: var(--text-secondary);
        }
        .structure-table tr.current-level td {
            color: var(--accent);
            font-weight: bold;
            background: rgba(255, 179, 0, 0.08);
        }
        .structure-table tr.past-level td {
            color: var(--text-muted);
            opacity: 0.5;
        }
        .structure-table tr.break-row td {
            color: var(--green);
            font-style: italic;
        }
        .structure-table tr.break-row.current-level td {
            color: var(--green);
            background: rgba(74, 222, 128, 0.08);
        }

        /* Status banner */
        .status-banner {
            text-align: center;
            padding: 12px;
            font-family: 'Staatliches', sans-serif;
            font-size: 1.3em;
            letter-spacing: 3px;
            color: var(--text-muted);
        }
        .status-banner.running { display: none; }

        /* Admin panel */
        .admin-panel {
            max-width: 600px;
            margin: 24px auto;
            padding: 0 20px 40px;
        }
        .admin-panel summary {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9em;
            padding: 8px 0;
            letter-spacing: 1px;
        }
        .admin-section {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 16px;
            margin: 12px 0;
        }
        .admin-section h3 {
            font-size: 0.85em;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .config-field label {
            display: block;
            font-size: 0.78em;
            color: var(--text-muted);
            margin-bottom: 3px;
        }
        .config-field input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text);
            padding: 8px 10px;
            font-size: 0.95em;
            font-family: monospace;
        }
        .config-field input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255,179,0,0.15);
        }

        .btn-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9em;
            cursor: pointer;
            text-align: center;
            transition: border-color 0.2s, background 0.2s;
        }
        .btn:hover {
            border-color: var(--accent);
            background: var(--bg-card-hover);
        }
        .btn:active { transform: scale(0.97); }
        .btn.accent {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }
        .btn.accent:hover { background: #ffc433; }
        .btn.danger { border-color: var(--red); color: var(--red); }
        .btn.danger:hover { background: rgba(248,113,113,0.1); }

        .player-counts {
            display: flex;
            gap: 16px;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        .player-counts span { color: var(--accent); font-weight: bold; }

        /* Break state */
        .blinds-current.on-break { color: var(--green); }
        .progress-bar.on-break { background: var(--green); }

        /* Waiting state */
        .display.waiting .timer { color: var(--text-muted); font-size: clamp(2rem, 8vw, 4rem); }

        /* Payout section */
        .payout-section {
            max-width: 600px;
            margin: 0 auto 8px;
            padding: 16px 20px;
        }
        .payout-header {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            font-size: 0.95em;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        .payout-header strong { color: var(--accent); }
        .payout-table {
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .payout-table th {
            color: var(--text-muted);
            font-weight: 500;
            text-align: center;
            padding: 4px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85em;
            letter-spacing: 1px;
        }
        .payout-table td {
            text-align: center;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            color: var(--text-secondary);
        }
        .bubble-banner {
            text-align: center;
            font-family: 'Staatliches', sans-serif;
            font-size: 1.6em;
            letter-spacing: 4px;
            color: var(--green);
            padding: 8px;
            margin-bottom: 8px;
            border: 2px solid var(--green);
            border-radius: 10px;
            animation: bubble-pulse 1.5s ease-in-out infinite;
        }
        @keyframes bubble-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Winner banner */
        .winner-banner {
            text-align: center;
            padding: 32px 20px;
            margin: 0 auto 8px;
            max-width: 600px;
        }
        .winner-banner .winner-label {
            font-family: 'Staatliches', sans-serif;
            font-size: 1.6em;
            letter-spacing: 4px;
            color: var(--text-muted);
        }
        .winner-banner .winner-name {
            font-family: 'Staatliches', sans-serif;
            font-size: clamp(3rem, 10vw, 6rem);
            letter-spacing: 4px;
            color: var(--accent);
            margin-top: 8px;
            line-height: 1.1;
        }

        .btn.knockout { border-color: var(--red); color: var(--red); }
        .btn.knockout:hover { background: rgba(248,113,113,0.1); }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="tracker-header">
        <div class="stats">
            Hráči: <span id="hd-active">0</span> / <span id="hd-buyin">0</span> &nbsp;|&nbsp;
            Žetony: <span id="hd-chips">0</span>
        </div>
    </div>

    <!-- Display -->
    <div class="display" id="display">
        <div class="status-banner" id="status-banner">ČEKÁ SE NA START</div>
        <div class="level-label" id="level-label">LEVEL 1</div>
        <div class="timer" id="timer">00:00</div>
        <div class="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>
        <div class="blinds-label" id="blinds-label">BLINDY</div>
        <div class="blinds-current" id="blinds-current">– / –</div>
        <div class="blinds-sub" id="blinds-sub"></div>
        <div class="next-level" id="next-level"></div>
    </div>

    <!-- Winner banner (shown when tournament ends) -->
    <div class="winner-banner" id="winner-banner" style="display:none">
        <div class="winner-label">VÍTĚZ TURNAJE</div>
        <div class="winner-name" id="winner-name"></div>
    </div>

    <!-- Payout section -->
    <div class="payout-section" id="payout-section">
        <div class="bubble-banner" id="bubble-banner" style="display:none">BUBBLE!</div>
        <div class="payout-header">
            <div>Hráči: <strong id="pay-active">0</strong> / <strong id="pay-buyin">0</strong></div>
            <div>Prize pool: <strong id="pay-pool">0 Kč</strong></div>
            <div>Vyplácí se: <strong id="pay-places">0</strong> místa</div>
        </div>
        <table class="payout-table">
            <thead><tr><th>Místo</th><th>%</th><th>Výhra</th></tr></thead>
            <tbody id="payout-body"></tbody>
        </table>
    </div>

    <!-- Blind structure table -->
    <div class="structure-wrap">
        <table class="structure-table">
            <thead>
                <tr><th>Čas</th><th>Level</th><th>SB</th><th>BB</th></tr>
            </thead>
            <tbody id="structure-body"></tbody>
        </table>
    </div>

    <!-- Admin panel (only with ?admin) -->
    <div class="admin-panel" id="admin-panel" style="display:none">
        <details>
            <summary>ADMIN OVLÁDÁNÍ</summary>

            <!-- Config -->
            <div class="admin-section">
                <h3>Nastavení turnaje</h3>
                <div class="config-grid">
                    <div class="config-field">
                        <label>Počáteční žetony hráče</label>
                        <input type="number" id="cfg-stack" value="5000">
                    </div>
                    <div class="config-field">
                        <label>Délka levelu (min)</label>
                        <input type="number" id="cfg-level-dur" value="20">
                    </div>
                    <div class="config-field">
                        <label>Celková délka turnaje (min)</label>
                        <input type="number" id="cfg-tourney-len" value="240">
                    </div>
                    <div class="config-field">
                        <label>Nejmenší žeton</label>
                        <input type="number" id="cfg-smallest" value="25">
                    </div>
                    <div class="config-field">
                        <label>Bonus žetony za včasný příchod</label>
                        <input type="number" id="cfg-bonus" value="5000">
                    </div>
                    <div class="config-field">
                        <label>Re-buy povolený do levelu</label>
                        <input type="number" id="cfg-rebuy-cutoff" value="4">
                    </div>
                    <div class="config-field">
                        <label>Přestávka po levelu (0 = žádná)</label>
                        <input type="number" id="cfg-break-after" value="0" min="0">
                    </div>
                    <div class="config-field">
                        <label>Délka přestávky (min)</label>
                        <input type="number" id="cfg-break-dur" value="30" min="1">
                    </div>
                    <div class="config-field">
                        <label>Buy-in (Kč)</label>
                        <input type="number" id="cfg-buyin-amount" value="400">
                    </div>
                </div>
                <div class="btn-row" style="margin-top:12px">
                    <button class="btn accent" id="btn-save-config">Uložit nastavení</button>
                </div>
            </div>

            <!-- Players -->
            <div class="admin-section">
                <h3>Hráči</h3>
                <div class="player-counts">
                    Přihlášení: <span id="ad-buyins">0</span>&nbsp;&nbsp;
                    Ve hře: <span id="ad-active">0</span>&nbsp;&nbsp;
                    Rebuys: <span id="ad-rebuys">0</span>&nbsp;&nbsp;
                    Bonusy: <span id="ad-bonuses">0</span>
                </div>
                <div class="btn-row">
                    <button class="btn" id="btn-add-player">+ Hráč</button>
                    <button class="btn" id="btn-remove-player">− Hráč</button>
                    <button class="btn knockout" id="btn-knockout">Vypadl hráč</button>
                </div>
                <div class="btn-row">
                    <button class="btn" id="btn-rebuy">Re-buy</button>
                    <button class="btn" id="btn-remove-rebuy">− Re-buy</button>
                    <button class="btn" id="btn-bonus">Bonus</button>
                </div>
            </div>

            <!-- End tournament -->
            <div class="admin-section">
                <h3>Ukončení turnaje</h3>
                <div class="config-field" style="margin-bottom:8px">
                    <label>Jméno vítěze</label>
                    <input type="text" id="cfg-winner" placeholder="Zadej jméno vítěze...">
                </div>
                <div class="btn-row">
                    <button class="btn accent" id="btn-end-tournament">Ukončit turnaj</button>
                </div>
            </div>

            <!-- Timer controls -->
            <div class="admin-section">
                <h3>Timer</h3>
                <div class="btn-row">
                    <button class="btn accent" id="btn-start">Start</button>
                    <button class="btn" id="btn-pause">Pauza</button>
                    <button class="btn danger" id="btn-reset">Reset</button>
                </div>
                <div class="btn-row">
                    <button class="btn" id="btn-prev-level">← Level</button>
                    <button class="btn" id="btn-next-level">Level →</button>
                </div>
            </div>
        </details>
    </div>

    <script>
    // ─── Firebase Init ──────────────────────────────────────────
    firebase.initializeApp({
        apiKey: "AIzaSyAfQqQYYn8pId99FbqIqX72LH6kOlosunQ",
        authDomain: "smelo-turnaj.firebaseapp.com",
        databaseURL: "https://smelo-turnaj-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "smelo-turnaj"
    });

    const db = firebase.database();
    const tournamentRef = db.ref('tournament');
    const isAdmin = location.search.includes('admin');

    if (isAdmin) document.getElementById('admin-panel').style.display = '';

    // ─── Server Time Sync ────────────────────────────────────────
    let serverTimeOffset = 0;
    db.ref('.info/serverTimeOffset').on('value', (snap) => {
        serverTimeOffset = snap.val() || 0;
    });
    function serverNow() { return Date.now() + serverTimeOffset; }

    // ─── Default data ───────────────────────────────────────────
    const DEFAULTS = {
        config: {
            startingStack: 5000,
            levelDuration: 20,
            tournamentLength: 240,
            smallestChip: 25,
            bonusAmount: 5000,
            rebuyCutoff: 4,
            breakAfterLevel: 0,
            breakDuration: 30,
            startTime: '19:00',
            buyInAmount: 400,
            date: ''
        },
        state: {
            status: 'waiting',   // waiting | running | paused | finished
            currentLevel: 0,
            timerEnd: 0,
            pausedRemaining: 0,
            startedAt: 0,
            winner: ''
        },
        players: {
            buyIns: 6,
            activePlayers: 6,
            rebuys: 0,
            bonuses: 0,
            totalChips: 0
        },
        blindStructure: []
    };

    // Local mirror
    let T = JSON.parse(JSON.stringify(DEFAULTS));

    // ─── Blind Calculation ──────────────────────────────────────
    function roundToChip(val, chip) {
        return Math.max(chip, Math.round(val / chip) * chip);
    }

    function calculateBlinds(config, totalChips, freezeUpTo) {
        const { levelDuration, tournamentLength, smallestChip } = config;
        const breakAfter = config.breakAfterLevel || 0;
        const breakDur = config.breakDuration || 30;
        const hasBreak = breakAfter > 0;

        // Subtract break from playing time before computing number of blind levels
        const playingTime = hasBreak ? tournamentLength - breakDur : tournamentLength;
        const numLevels = Math.max(2, Math.floor(playingTime / levelDuration));
        const finalBigBlind = roundToChip(totalChips / 3, smallestChip);
        const finalSmall = finalBigBlind / 2;
        const startSmall = smallestChip;

        const levels = [];

        if (freezeUpTo >= 0 && T.blindStructure && T.blindStructure.length > 0) {
            // Freeze existing entries up to and including freezeUpTo (skip breaks from count)
            const frozen = Math.min(freezeUpTo + 1, T.blindStructure.length);
            for (let i = 0; i < frozen; i++) {
                levels.push({ ...T.blindStructure[i] });
            }

            // Count only real blind levels among frozen entries
            const frozenBlindCount = levels.filter(l => !l.isBreak).length;
            const remaining = numLevels - frozenBlindCount;

            if (remaining > 0) {
                // Find last real blind level for progression base
                const lastBlind = [...levels].reverse().find(l => !l.isBreak);
                const currentSmall = lastBlind ? lastBlind.small : smallestChip;
                const newFinalSmall = Math.max(currentSmall, roundToChip(totalChips / 6, smallestChip));
                const ratio = remaining > 1
                    ? Math.pow(newFinalSmall / currentSmall, 1 / (remaining - 1))
                    : 1;

                for (let i = 0; i < remaining; i++) {
                    const small = i === remaining - 1
                        ? newFinalSmall
                        : roundToChip(currentSmall * Math.pow(ratio, i + 1), smallestChip);
                    const big = small * 2;
                    levels.push({ small, big, duration: levelDuration });
                }
            }
        } else {
            // Fresh calculation
            const ratio = numLevels > 1
                ? Math.pow(finalSmall / startSmall, 1 / (numLevels - 1))
                : 1;

            for (let i = 0; i < numLevels; i++) {
                const small = i === 0
                    ? startSmall
                    : (i === numLevels - 1
                        ? roundToChip(finalSmall, smallestChip)
                        : roundToChip(startSmall * Math.pow(ratio, i), smallestChip));
                const big = small * 2;
                levels.push({ small, big, duration: levelDuration });
            }
        }

        // Insert break as its own level after the configured blind level
        if (hasBreak && breakAfter <= levels.length) {
            levels.splice(breakAfter, 0, {
                small: 0, big: 0,
                duration: breakDur,
                isBreak: true
            });
        }

        return levels;
    }

    function recalcTotalChips() {
        const p = T.players;
        const c = T.config;
        return (p.buyIns + p.rebuys) * c.startingStack + p.bonuses * c.bonusAmount;
    }

    // ─── Payout Calculation ──────────────────────────────────────
    const PAYOUT_STRUCTURES = {
        1: [100],
        2: [65, 35],
        3: [50, 30, 20]
    };

    function getPayoutDistribution(paidPlaces) {
        if (paidPlaces <= 0) return [];
        if (PAYOUT_STRUCTURES[paidPlaces]) return PAYOUT_STRUCTURES[paidPlaces];
        // 4+ spots: 1st=40%, 2nd=25%, 3rd=18%, rest split evenly
        const remaining = 17;
        const extraPlaces = paidPlaces - 3;
        const perExtra = Math.round(remaining / extraPlaces * 10) / 10;
        const dist = [40, 25, 18];
        for (let i = 0; i < extraPlaces; i++) dist.push(perExtra);
        return dist;
    }

    function renderPayout() {
        const { players, config, state } = T;
        const buyIns = players.buyIns || 0;
        const rebuys = players.rebuys || 0;
        const activePlayers = players.activePlayers || 0;
        const buyInAmount = config.buyInAmount || 400;

        const prizePool = (buyIns + rebuys) * buyInAmount;
        const paidPlaces = Math.max(1, Math.floor(buyIns * 0.25));
        const dist = getPayoutDistribution(paidPlaces);

        document.getElementById('pay-active').textContent = activePlayers;
        document.getElementById('pay-buyin').textContent = buyIns;
        document.getElementById('pay-pool').textContent =
            prizePool.toLocaleString('cs') + ' Kč';
        document.getElementById('pay-places').textContent = paidPlaces;

        const tbody = document.getElementById('payout-body');
        tbody.innerHTML = '';
        dist.forEach((pct, i) => {
            const tr = document.createElement('tr');
            const amount = Math.round(prizePool * pct / 100);
            tr.innerHTML =
                '<td>' + (i + 1) + '.</td>' +
                '<td>' + pct + '%</td>' +
                '<td>' + amount.toLocaleString('cs') + ' Kč</td>';
            tbody.appendChild(tr);
        });

        // Bubble indicator
        const bubble = document.getElementById('bubble-banner');
        const isBubble = state.status !== 'waiting' && activePlayers === paidPlaces + 1 && activePlayers > 1;
        bubble.style.display = isBubble ? '' : 'none';
    }

    function recalcAndSync() {
        const totalChips = recalcTotalChips();
        const freezeUpTo = T.state.status === 'waiting' ? -1 : T.state.currentLevel;
        const structure = calculateBlinds(T.config, totalChips, freezeUpTo);

        tournamentRef.child('players/totalChips').set(totalChips);
        tournamentRef.child('blindStructure').set(structure);
    }

    // ─── Rendering ──────────────────────────────────────────────
    function formatTime(ms) {
        if (ms <= 0) return '00:00';
        const totalSec = Math.ceil(ms / 1000);
        const m = Math.floor(totalSec / 60);
        const s = totalSec % 60;
        return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    function render() {
        const { config, state, players, blindStructure } = T;

        // Header stats
        document.getElementById('hd-active').textContent = players.activePlayers;
        document.getElementById('hd-buyin').textContent = players.buyIns;
        document.getElementById('hd-chips').textContent = players.totalChips.toLocaleString('cs');

        // Admin player counts
        if (isAdmin) {
            document.getElementById('ad-buyins').textContent = players.buyIns;
            document.getElementById('ad-active').textContent = players.activePlayers;
            document.getElementById('ad-rebuys').textContent = players.rebuys;
            document.getElementById('ad-bonuses').textContent = players.bonuses;
        }

        // Winner banner — hide timer/blinds/structure when finished
        const isFinished = state.status === 'finished' && state.winner;
        const winnerBanner = document.getElementById('winner-banner');
        document.getElementById('display').style.display = isFinished ? 'none' : '';
        document.querySelector('.structure-wrap').style.display = isFinished ? 'none' : '';
        if (isFinished) {
            winnerBanner.style.display = '';
            document.getElementById('winner-name').textContent = state.winner;
        } else {
            winnerBanner.style.display = 'none';
        }

        // Status banner
        const banner = document.getElementById('status-banner');
        if (state.status === 'waiting') {
            banner.textContent = 'ČEKÁ SE NA START';
            banner.className = 'status-banner';
        } else if (state.status === 'paused') {
            banner.textContent = 'PAUZA';
            banner.className = 'status-banner';
        } else if (state.status === 'finished') {
            banner.textContent = 'TURNAJ UKONČEN';
            banner.className = 'status-banner';
        } else {
            banner.className = 'status-banner running';
        }

        // Current blinds
        const lvl = state.currentLevel;
        const struct = blindStructure || [];

        const curEntry = struct[lvl];
        const onBreak = curEntry && curEntry.isBreak;
        const blindsCurEl = document.getElementById('blinds-current');
        const progressBarEl = document.getElementById('progress-bar');

        // Level label
        if (!struct.length) {
            document.getElementById('level-label').textContent = '';
        } else if (onBreak) {
            document.getElementById('level-label').textContent = 'PŘESTÁVKA';
        } else {
            // Display level number excluding break entries from the count
            const displayNum = struct.slice(0, lvl + 1).filter(s => !s.isBreak).length;
            document.getElementById('level-label').textContent = 'LEVEL ' + displayNum;
        }

        // Blinds / break display
        const blindsLabelEl = document.getElementById('blinds-label');
        if (onBreak) {
            blindsLabelEl.style.display = 'none';
            blindsCurEl.textContent = 'PŘESTÁVKA';
            blindsCurEl.classList.add('on-break');
            progressBarEl.classList.add('on-break');
            document.getElementById('blinds-sub').textContent =
                curEntry.duration + ' min';
        } else if (curEntry) {
            blindsLabelEl.style.display = '';
            blindsCurEl.textContent =
                curEntry.small.toLocaleString('cs') + ' / ' + curEntry.big.toLocaleString('cs');
            blindsCurEl.classList.remove('on-break');
            progressBarEl.classList.remove('on-break');
            document.getElementById('blinds-sub').textContent = '';
        } else {
            blindsLabelEl.style.display = '';
            blindsCurEl.textContent = '– / –';
            blindsCurEl.classList.remove('on-break');
            progressBarEl.classList.remove('on-break');
            document.getElementById('blinds-sub').textContent = '';
        }

        // Next level preview (skip break entries to show next real level)
        const nextEl = document.getElementById('next-level');
        const nextReal = struct.slice(lvl + 1).find(s => !s.isBreak);
        if (nextReal) {
            nextEl.innerHTML = 'Další blindy: <span>' +
                nextReal.small.toLocaleString('cs') + ' / ' + nextReal.big.toLocaleString('cs') +
                '</span>';
        } else {
            nextEl.textContent = '';
        }

        // Structure table
        const tbody = document.getElementById('structure-body');
        tbody.innerHTML = '';
        // Use actual startedAt timestamp when tournament has started, otherwise config startTime
        let runningMinutes;
        if (state.startedAt) {
            const d = new Date(state.startedAt);
            runningMinutes = d.getHours() * 60 + d.getMinutes();
        } else {
            const startTimeParts = (config.startTime || '19:00').split(':');
            runningMinutes = parseInt(startTimeParts[0]) * 60 + parseInt(startTimeParts[1]);
        }

        let levelNum = 0;
        struct.forEach((s, i) => {
            const tr = document.createElement('tr');
            const classes = [];
            if (i === lvl) classes.push('current-level');
            else if (i < lvl) classes.push('past-level');

            const hh = String(Math.floor(runningMinutes / 60) % 24).padStart(2, '0');
            const mm = String(runningMinutes % 60).padStart(2, '0');
            const timeStr = hh + ':' + mm;

            if (s.isBreak) {
                classes.push('break-row');
                tr.className = classes.join(' ');
                tr.innerHTML =
                    '<td>' + timeStr + '</td>' +
                    '<td colspan="3">PŘESTÁVKA</td>';
            } else {
                levelNum++;
                tr.className = classes.join(' ');
                tr.innerHTML =
                    '<td>' + timeStr + '</td>' +
                    '<td>' + levelNum + '</td>' +
                    '<td>' + s.small.toLocaleString('cs') + '</td>' +
                    '<td>' + s.big.toLocaleString('cs') + '</td>';
            }
            runningMinutes += s.duration;
            tbody.appendChild(tr);
        });

        // Payout (always visible)
        renderPayout();

        // Populate config inputs from current data
        if (isAdmin) {
            const ids = {
                'cfg-stack': config.startingStack,
                'cfg-level-dur': config.levelDuration,
                'cfg-tourney-len': config.tournamentLength,
                'cfg-smallest': config.smallestChip,
                'cfg-bonus': config.bonusAmount,
                'cfg-rebuy-cutoff': config.rebuyCutoff,
                'cfg-break-after': config.breakAfterLevel,
                'cfg-break-dur': config.breakDuration,
                'cfg-buyin-amount': config.buyInAmount
            };
            for (const [id, val] of Object.entries(ids)) {
                const el = document.getElementById(id);
                if (el && document.activeElement !== el) el.value = val;
            }

            // Rebuy cutoff enforcement
            const rebuyClosed = state.currentLevel >= config.rebuyCutoff && state.status !== 'waiting';
            const rebuyBtn = document.getElementById('btn-rebuy');
            const removeRebuyBtn = document.getElementById('btn-remove-rebuy');
            if (rebuyClosed) {
                rebuyBtn.disabled = true;
                rebuyBtn.title = 'Rebuy uzavřen po levelu ' + config.rebuyCutoff;
            } else {
                rebuyBtn.disabled = false;
                rebuyBtn.title = '';
            }
            removeRebuyBtn.disabled = players.rebuys <= 0;
        }
    }

    // ─── Timer Loop ─────────────────────────────────────────────
    let timerInterval = null;

    function startTimerLoop() {
        if (timerInterval) return;
        timerInterval = setInterval(tickTimer, 100);
    }

    function tickTimer() {
        const { state, blindStructure } = T;
        const timerEl = document.getElementById('timer');
        const progressEl = document.getElementById('progress-bar');

        if (state.status === 'running' && state.timerEnd > 0) {
            const remaining = state.timerEnd - serverNow();
            timerEl.textContent = formatTime(remaining);
            timerEl.classList.remove('paused');
            timerEl.classList.toggle('warning', remaining <= 30000 && remaining > 0);

            // Progress bar
            const duration = (blindStructure[state.currentLevel]?.duration || 20) * 60 * 1000;
            const elapsed = duration - remaining;
            const pct = Math.min(100, Math.max(0, (elapsed / duration) * 100));
            progressEl.style.width = pct + '%';

            // Auto-advance
            if (remaining <= 0 && isAdmin) {
                advanceLevel();
            }
        } else if (state.status === 'paused') {
            timerEl.textContent = formatTime(state.pausedRemaining);
            timerEl.classList.add('paused');
            timerEl.classList.remove('warning');

            const duration = (blindStructure[state.currentLevel]?.duration || 20) * 60 * 1000;
            const elapsed = duration - state.pausedRemaining;
            const pct = Math.min(100, Math.max(0, (elapsed / duration) * 100));
            progressEl.style.width = pct + '%';
        } else {
            // Waiting
            const duration = (blindStructure[state.currentLevel]?.duration || 20) * 60 * 1000;
            timerEl.textContent = formatTime(duration);
            timerEl.classList.remove('paused', 'warning');
            progressEl.style.width = '0%';
        }
    }

    startTimerLoop();

    function advanceLevel() {
        const struct = T.blindStructure || [];
        const nextLevel = T.state.currentLevel + 1;
        if (nextLevel >= struct.length) return;

        const duration = (struct[nextLevel]?.duration || 20) * 60 * 1000;
        tournamentRef.child('state').update({
            currentLevel: nextLevel,
            timerEnd: serverNow() + duration,
            pausedRemaining: 0
        });
    }

    // ─── Firebase Listener ──────────────────────────────────────
    tournamentRef.on('value', (snap) => {
        const data = snap.val();
        if (!data) {
            // Initialize with defaults
            if (isAdmin) {
                tournamentRef.set(DEFAULTS);
            }
            return;
        }

        T.config = { ...DEFAULTS.config, ...data.config };
        T.state = { ...DEFAULTS.state, ...data.state };

        // Migrate old "count" field to "buyIns" / "activePlayers"
        const rawPlayers = data.players || {};
        if (rawPlayers.count !== undefined && rawPlayers.buyIns === undefined) {
            rawPlayers.buyIns = rawPlayers.count;
            rawPlayers.activePlayers = rawPlayers.count;
            delete rawPlayers.count;
        }
        T.players = { ...DEFAULTS.players, ...rawPlayers };
        T.blindStructure = data.blindStructure || [];

        render();
    });

    // ─── Admin Actions ──────────────────────────────────────────
    if (isAdmin) {
        // Save config
        document.getElementById('btn-save-config').addEventListener('click', () => {
            const config = {
                startingStack: parseInt(document.getElementById('cfg-stack').value) || 5000,
                levelDuration: parseInt(document.getElementById('cfg-level-dur').value) || 20,
                tournamentLength: parseInt(document.getElementById('cfg-tourney-len').value) || 240,
                smallestChip: parseInt(document.getElementById('cfg-smallest').value) || 25,
                bonusAmount: parseInt(document.getElementById('cfg-bonus').value) || 5000,
                rebuyCutoff: parseInt(document.getElementById('cfg-rebuy-cutoff').value) || 4,
                breakAfterLevel: parseInt(document.getElementById('cfg-break-after').value) || 0,
                breakDuration: parseInt(document.getElementById('cfg-break-dur').value) || 30,
                buyInAmount: parseInt(document.getElementById('cfg-buyin-amount').value) || 400
            };
            tournamentRef.child('config').set(config).then(() => {
                T.config = config;
                recalcAndSync();
                const btn = document.getElementById('btn-save-config');
                btn.textContent = 'Nastavení uloženo ✓';
                setTimeout(() => { btn.textContent = 'Uložit nastavení'; }, 2000);
            });
        });

        // Player buttons
        document.getElementById('btn-add-player').addEventListener('click', () => {
            const updates = {};
            updates['players/buyIns'] = (T.players.buyIns || 0) + 1;
            updates['players/activePlayers'] = (T.players.activePlayers || 0) + 1;
            tournamentRef.update(updates).then(() => recalcAndSync());
        });

        document.getElementById('btn-remove-player').addEventListener('click', () => {
            const updates = {};
            updates['players/buyIns'] = Math.max(0, (T.players.buyIns || 0) - 1);
            updates['players/activePlayers'] = Math.max(0, (T.players.activePlayers || 0) - 1);
            tournamentRef.update(updates).then(() => recalcAndSync());
        });

        document.getElementById('btn-knockout').addEventListener('click', () => {
            if (T.players.activePlayers <= 0) return;
            tournamentRef.child('players/activePlayers').set(T.players.activePlayers - 1);
        });

        document.getElementById('btn-rebuy').addEventListener('click', () => {
            if (T.state.currentLevel >= T.config.rebuyCutoff && T.state.status !== 'waiting') return;
            const updates = {};
            updates['players/rebuys'] = (T.players.rebuys || 0) + 1;
            updates['players/buyIns'] = (T.players.buyIns || 0) + 1;
            updates['players/activePlayers'] = (T.players.activePlayers || 0) + 1;
            tournamentRef.update(updates).then(() => recalcAndSync());
        });

        document.getElementById('btn-remove-rebuy').addEventListener('click', () => {
            if (T.players.rebuys <= 0) return;
            const updates = {};
            updates['players/rebuys'] = Math.max(0, (T.players.rebuys || 0) - 1);
            updates['players/buyIns'] = Math.max(0, (T.players.buyIns || 0) - 1);
            updates['players/activePlayers'] = Math.max(0, (T.players.activePlayers || 0) - 1);
            tournamentRef.update(updates).then(() => recalcAndSync());
        });

        document.getElementById('btn-bonus').addEventListener('click', () => {
            tournamentRef.child('players/bonuses').transaction(v => (v || 0) + 1, () => recalcAndSync());
        });

        // End tournament
        document.getElementById('btn-end-tournament').addEventListener('click', () => {
            const winner = document.getElementById('cfg-winner').value.trim();
            if (!winner) { alert('Zadej jméno vítěze!'); return; }
            tournamentRef.child('state').update({
                status: 'finished',
                winner: winner
            });
        });

        // Timer controls
        document.getElementById('btn-start').addEventListener('click', () => {
            const status = T.state.status;
            if (status === 'running') return;

            if (status === 'paused' && T.state.pausedRemaining > 0) {
                // Resume
                tournamentRef.child('state').update({
                    status: 'running',
                    timerEnd: serverNow() + T.state.pausedRemaining,
                    pausedRemaining: 0
                });
            } else {
                // Fresh start
                const struct = T.blindStructure || [];
                const duration = (struct[T.state.currentLevel]?.duration || 20) * 60 * 1000;
                tournamentRef.child('state').update({
                    status: 'running',
                    timerEnd: serverNow() + duration,
                    pausedRemaining: 0,
                    startedAt: serverNow()
                });
            }
        });

        document.getElementById('btn-pause').addEventListener('click', () => {
            if (T.state.status !== 'running') return;
            const remaining = Math.max(0, T.state.timerEnd - serverNow());
            tournamentRef.child('state').update({
                status: 'paused',
                timerEnd: 0,
                pausedRemaining: remaining
            });
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            tournamentRef.child('state').set(DEFAULTS.state);
            tournamentRef.child('players').set(DEFAULTS.players);
            recalcAndSync();
        });

        document.getElementById('btn-prev-level').addEventListener('click', () => {
            const newLevel = Math.max(0, T.state.currentLevel - 1);
            const struct = T.blindStructure || [];
            const duration = (struct[newLevel]?.duration || 20) * 60 * 1000;

            if (T.state.status === 'running') {
                tournamentRef.child('state').update({
                    currentLevel: newLevel,
                    timerEnd: serverNow() + duration,
                    pausedRemaining: 0
                });
            } else {
                tournamentRef.child('state').update({
                    currentLevel: newLevel,
                    pausedRemaining: duration
                });
            }
        });

        document.getElementById('btn-next-level').addEventListener('click', () => {
            advanceLevel();
        });
    }
    </script>
</body>
</html>
