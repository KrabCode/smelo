<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blind Tracker – SMELO.CZ</title>
    <link rel="icon" type="image/x-icon" href="../../favicon.ico">
    <link rel="stylesheet" href="../../base.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

    <style>
        body { min-height: 100vh; }

        /* Header bar */
        .tracker-header {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px 24px;
            padding: 14px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-card);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .tracker-header .stat-item {
            font-size: 0.9em;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        .tracker-header .stat-item span { color: var(--accent); font-weight: bold; }
        .tracker-header .stat-item .muted { color: var(--text-secondary); font-weight: normal; }
        .tracker-footer {
            font-family: 'Staatliches', sans-serif;
            font-size: 0.9em;
            letter-spacing: 2px;
            color: var(--accent);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            overflow: hidden;
            white-space: nowrap;
            padding: 10px 0;
        }
        .tracker-footer .ticker-track {
            display: inline-flex;
            animation: ticker 40s linear infinite;
        }
        .tracker-footer .ticker-half {
            flex-shrink: 0;
        }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .zoom-controls {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tracker-header:hover .zoom-controls { opacity: 1; }
        .zoom-controls button {
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            color: var(--text-muted);
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1em;
            line-height: 1;
        }
        .zoom-controls button:hover { border-color: var(--accent); color: var(--text); }

        /* Main display */
        .display { text-align: center; padding: 24px 20px 12px; }

        .timer {
            font-family: 'Staatliches', sans-serif;
            font-size: clamp(4rem, 15vw, 10rem);
            letter-spacing: 0.05em;
            color: var(--text);
            line-height: 1;
            margin: 8px 0;
        }
        .timer.warning { color: var(--red); }

        /* Progress bar */
        .progress-wrap {
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.2s linear;
        }

        /* Blinds display */
        .blinds-label {
            font-size: 0.85em;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-top: 8px;
        }
        .blinds-current {
            font-family: 'DM Sans', sans-serif;
            font-weight: 700;
            font-size: clamp(2.5rem, 8vw, 5rem);
            color: var(--accent);
            letter-spacing: 2px;
            margin: 8px 0;
        }
        .blinds-sub {
            font-family: 'Staatliches', sans-serif;
            font-size: clamp(1.2rem, 4vw, 2rem);
            color: var(--text-muted);
            letter-spacing: 2px;
        }

        .next-level {
            margin-top: 16px;
            font-size: 1em;
            color: var(--text-muted);
        }
        .next-level span { color: var(--text-secondary); }

        /* Blind structure table */
        .structure-wrap {
            max-width: 600px;
            margin: 24px auto;
            padding: 0 20px;
        }
        .structure-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .structure-table th {
            color: var(--text-muted);
            font-weight: 500;
            text-align: center;
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85em;
            letter-spacing: 1px;
        }
        .structure-table td {
            text-align: center;
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            color: var(--text-secondary);
        }
        .structure-table tr.current-level td {
            color: var(--accent);
            font-weight: bold;
            background: rgba(255, 179, 0, 0.08);
        }
        .structure-table tr.past-level {
            display: none;
        }
        .structure-table tr.break-row td {
            color: var(--green);
        }
        .structure-table tr.break-row.current-level td {
            color: var(--green);
            background: rgba(74, 222, 128, 0.08);
        }

        /* Admin panel */
        .admin-panel {
            max-width: 600px;
            margin: 24px auto;
            padding: 0 20px 40px;
        }
        .admin-panel summary {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 0.9em;
            padding: 8px 0;
            letter-spacing: 1px;
        }
        .admin-section {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 16px;
            margin: 12px 0;
        }
        .admin-section h3 {
            font-size: 0.85em;
            color: var(--text-muted);
            letter-spacing: 1px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .config-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .config-sub {
            grid-column: 1 / -1;
            font-size: 0.75em;
            color: var(--text-muted);
            letter-spacing: 1px;
            text-transform: uppercase;
            padding-top: 8px;
            border-top: 1px solid rgba(255,255,255,0.06);
            margin-top: 4px;
        }
        .config-sub:first-child { border-top: none; padding-top: 0; margin-top: 0; }
        .config-field label {
            display: block;
            font-size: 0.78em;
            color: var(--text-muted);
            margin-bottom: 3px;
        }
        .config-field input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text);
            padding: 8px 10px;
            font-size: 0.95em;
            font-family: monospace;
        }
        .note-row {
            display: flex;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }
        .note-row input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid var(--border-light);
            border-radius: 6px;
            color: var(--text);
            padding: 8px 10px;
            font-size: 0.95em;
        }
        .note-row input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255,179,0,0.15);
        }
        .note-row .btn-remove-note {
            flex: 0 0 auto;
            background: none;
            border: none;
            color: var(--red);
            cursor: pointer;
            font-size: 1.2em;
            padding: 4px 8px;
            opacity: 0.6;
        }
        .note-row .btn-remove-note:hover { opacity: 1; }

        .config-field input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(255,179,0,0.15);
        }

        .btn-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .btn {
            flex: 1;
            min-width: 80px;
            padding: 10px 12px;
            border: 1px solid var(--border-light);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 0.9em;
            cursor: pointer;
            text-align: center;
            transition: border-color 0.2s, background 0.2s;
        }
        .btn:hover {
            border-color: var(--accent);
            background: var(--bg-card-hover);
        }
        .btn:active { transform: scale(0.97); }
        .btn.accent {
            background: var(--accent);
            color: #000;
            border-color: var(--accent);
            font-weight: 600;
        }
        .btn.accent:hover { background: #ffc433; }
        .btn.danger { border-color: var(--red); color: var(--red); }
        .btn.danger:hover { background: rgba(248,113,113,0.1); }

        /* Frozen admin section */
        .admin-section.frozen { opacity: 0.45; pointer-events: none; }
        .admin-section.frozen h3::after {
            content: ' (uzamčeno)';
            font-weight: 400;
            text-transform: none;
            letter-spacing: 0;
        }

        /* Break state */
        .blinds-current.on-break { color: var(--green); }
        .progress-bar.on-break { background: var(--green); }

        /* Payout section */
        .payout-section {
            max-width: 600px;
            margin: 8px auto 24px;
            padding: 0 20px;
        }
        .payout-table {
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .payout-table th {
            color: var(--text-muted);
            font-weight: 500;
            text-align: center;
            padding: 4px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.85em;
            letter-spacing: 1px;
        }
        .payout-table td {
            text-align: center;
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            color: var(--text-secondary);
        }

        /* Winner banner */
        .winner-banner {
            text-align: center;
            padding: 32px 20px;
            margin: 0 auto 8px;
            max-width: 600px;
        }
        .winner-banner .winner-label {
            font-family: 'Staatliches', sans-serif;
            font-size: 1.6em;
            letter-spacing: 4px;
            color: var(--text-muted);
        }
        .winner-entry {
            font-family: 'Staatliches', sans-serif;
            letter-spacing: 3px;
            margin-top: 8px;
            line-height: 1.3;
        }
        .winner-entry .place { color: var(--text-muted); }
        .winner-entry .name { color: var(--accent); }
        .winner-entry:first-child {
            font-size: clamp(2.5rem, 8vw, 5rem);
        }
        .winner-entry:nth-child(2) {
            font-size: clamp(1.8rem, 5vw, 3rem);
        }
        .winner-entry:nth-child(n+3) {
            font-size: clamp(1.2rem, 3vw, 2rem);
        }

        /* Tablet mode (?wide) — side-by-side layout for 1920×1200 */
        body.wide { font-size: 1.3em; }
        body.wide .tracker-header { padding: 18px 32px; gap: 16px 32px; }
        body.wide .tracker-footer { font-size: 1em; }
        body.wide .main-content {
            display: flex;
            align-items: flex-start;
            max-width: 1920px;
            margin: 0 auto;
        }
        body.wide .display {
            flex: 1;
            padding: 40px 32px 16px;
        }
        body.wide .sidebar {
            width: 420px;
            flex-shrink: 0;
            padding: 16px 24px 16px 0;
        }
        body.wide .timer { font-size: clamp(6rem, 12vw, 12rem); }
        body.wide .blinds-current { font-size: clamp(3rem, 7vw, 6rem); }
        body.wide .blinds-label { font-size: 1em; }
        body.wide .blinds-sub { font-size: clamp(1.4rem, 3vw, 2.4rem); }
        body.wide .next-level { font-size: 1.2em; }
        body.wide .progress-wrap { max-width: 600px; height: 8px; }
        body.wide .structure-wrap { max-width: 100%; margin: 0; padding: 0; }
        body.wide .structure-table { font-size: 1em; }
        body.wide .payout-section { max-width: 100%; margin: 16px 0; padding: 0; }
        body.wide .payout-table { max-width: 100%; font-size: 1em; }
        body.wide .winner-banner { max-width: 100%; }

    </style>
</head>
<body>
    <!-- Header -->
    <div class="tracker-header">
        <div class="stat-item">Buy-in: <span id="hd-buyin-amount">400 Kč</span></div>
        <div class="stat-item">Žetony: <span id="hd-chips">0</span></div>
        <div class="stat-item">Prize pool: <span id="hd-pool">0 Kč</span> / <span id="hd-places">0</span> <span id="hd-places-label">výherců</span></div>
        <div class="stat-item">Hráči: <span id="hd-active">0</span> / <span id="hd-buyin">0</span></div>
        <div class="stat-item" id="hd-start-item" style="display:none">Start: <span id="hd-start">–</span></div>
        <div class="zoom-controls">
            <button id="zoom-out">−</button>
            <button id="zoom-in">+</button>
            <button id="btn-test-sound" title="Test zvuku">♪</button>
        </div>
    </div>
    <div class="main-content">
        <!-- Display -->
        <div class="display" id="display">
            <div class="timer" id="timer">00:00</div>
            <div class="progress-wrap"><div class="progress-bar" id="progress-bar"></div></div>
            <div class="blinds-label" id="blinds-label">BLINDY</div>
            <div class="blinds-current" id="blinds-current">– / –</div>
            <div class="blinds-sub" id="blinds-sub"></div>
            <div class="next-level" id="next-level"></div>
        </div>

        <!-- Winner banner (shown when all places declared) -->
        <div class="winner-banner" id="winner-banner" style="display:none">
            <div class="winner-label">VÝSLEDKY TURNAJE</div>
            <div id="winner-list"></div>
        </div>

        <div class="sidebar">
            <!-- Blind structure table -->
            <div class="structure-wrap">
                <table class="structure-table">
                    <thead>
                        <tr><th>Level</th><th>Čas</th><th>SB</th><th>BB</th></tr>
                    </thead>
                    <tbody id="structure-body"></tbody>
                </table>
            </div>

            <!-- Payout section (below structure, appears as levels shrink) -->
            <div class="payout-section" id="payout-section">
                <table class="payout-table">
                    <thead><tr><th>Místo</th><th>%</th><th>Výhra</th></tr></thead>
                    <tbody id="payout-body"></tbody>
                </table>
            </div>
        </div><!-- .sidebar -->
    </div><!-- .main-content -->

    <!-- Admin panel (only with ?admin) -->
    <div class="admin-panel" id="admin-panel" style="display:none">
        <details>
            <summary>ADMIN OVLÁDÁNÍ</summary>

            <!-- Tournament config (frozen when running) -->
            <div class="admin-section" id="section-config">
                <h3>Nastavení turnaje</h3>
                <div class="config-grid">
                    <div class="config-sub">Struktura</div>
                    <div class="config-field">
                        <label>Délka levelu (min)</label>
                        <input type="number" id="cfg-level-dur" value="20">
                    </div>
                    <div class="config-field">
                        <label>Celková délka turnaje (min)</label>
                        <input type="number" id="cfg-tourney-len" value="240">
                    </div>
                    <div class="config-sub">Žetony</div>
                    <div class="config-field">
                        <label>Počáteční žetony hráče</label>
                        <input type="number" id="cfg-stack" value="5000">
                    </div>
                    <div class="config-field">
                        <label>Nejmenší žeton</label>
                        <input type="number" id="cfg-smallest" value="25">
                    </div>
                    <div class="config-field">
                        <label>Bonus žetony za včasný příchod</label>
                        <input type="number" id="cfg-bonus" value="5000">
                    </div>
                    <div class="config-sub">Buy-in a re-buy</div>
                    <div class="config-field">
                        <label>Buy-in (Kč)</label>
                        <input type="number" id="cfg-buyin-amount" value="400">
                    </div>
                    <div class="config-field">
                        <label>Re-buy povolený do levelu</label>
                        <input type="number" id="cfg-rebuy-cutoff" value="4">
                    </div>
                    <div class="config-sub">Přestávka</div>
                    <div class="config-field">
                        <label>Přestávka po levelu (0 = žádná)</label>
                        <input type="number" id="cfg-break-after" value="0" min="0">
                    </div>
                    <div class="config-field">
                        <label>Délka přestávky (min)</label>
                        <input type="number" id="cfg-break-dur" value="30" min="1">
                    </div>
                </div>
                <div class="btn-row" style="margin-top:12px">
                    <button class="btn accent" id="btn-save-config">Uložit nastavení</button>
                </div>
            </div>

            <!-- Player counters (always editable) -->
            <div class="admin-section" id="section-players">
                <h3>Hráči</h3>
                <div class="config-grid">
                    <div class="config-field">
                        <label>Přihlášení (buy-ins)</label>
                        <input type="number" id="cfg-buyins" value="6" min="0">
                    </div>
                    <div class="config-field">
                        <label>Ve hře</label>
                        <input type="number" id="cfg-active" value="6" min="0">
                    </div>
                    <div class="config-field">
                        <label>Re-buys</label>
                        <input type="number" id="cfg-rebuys" value="0" min="0">
                    </div>
                    <div class="config-field">
                        <label>Bonusy</label>
                        <input type="number" id="cfg-bonuses" value="0" min="0">
                    </div>
                </div>
                <div class="btn-row" style="margin-top:8px">
                    <button class="btn" id="btn-add-player">+ Hráč</button>
                    <button class="btn" id="btn-bonus">+ Bonus</button>
                    <button class="btn" id="btn-knockout">Vypadl hráč</button>
                    <button class="btn" id="btn-rebuy">+ Re-buy</button>
                </div>
                <div id="player-save-status" style="margin-top:8px;font-size:0.8em;color:var(--text-muted);text-align:center;min-height:1.2em"></div>
            </div>

            <!-- Winners -->
            <div class="admin-section">
                <h3>Výsledky</h3>
                <div id="winners-fields"></div>
                <div class="btn-row" style="margin-top:8px">
                    <button class="btn accent" id="btn-save-winners">Uložit výsledky</button>
                </div>
            </div>

            <!-- Timer controls -->
            <div class="admin-section">
                <h3>Timer</h3>
                <div class="btn-row">
                    <button class="btn accent" id="btn-start">Start</button>
                    <button class="btn danger" id="btn-reset">Reset</button>
                </div>
                <div id="start-time-row" style="display:none;margin-top:10px">
                    <div class="config-field">
                        <label>Čas startu (posun timeru)</label>
                        <div style="display:flex;gap:6px;align-items:center">
                            <input type="time" id="cfg-start-time" step="60">
                            <button class="btn" id="btn-set-start-time" style="flex:0 0 auto;min-width:auto;padding:8px 12px">Nastavit</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes (ticker) -->
            <div class="admin-section">
                <h3>Poznámky (ticker)</h3>
                <div id="notes-list"></div>
                <div class="btn-row" style="margin-top:8px">
                    <button class="btn" id="btn-add-note">+ Poznámka</button>
                    <button class="btn accent" id="btn-save-notes">Uložit poznámky</button>
                </div>
            </div>
        </details>
    </div>

    <div class="tracker-footer" id="tracker-footer"><span class="ticker-track"><span class="ticker-half" id="ticker-a"></span><span class="ticker-half" id="ticker-b"></span></span></div>

    <script>
    // ─── Firebase Init ──────────────────────────────────────────
    firebase.initializeApp({
        apiKey: "AIzaSyAfQqQYYn8pId99FbqIqX72LH6kOlosunQ",
        authDomain: "smelo-turnaj.firebaseapp.com",
        databaseURL: "https://smelo-turnaj-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "smelo-turnaj"
    });

    const db = firebase.database();
    const tournamentRef = db.ref('tournament');
    const isAdmin = location.search.includes('admin');

    if (isAdmin) {
        document.getElementById('admin-panel').style.display = '';
        document.querySelector('#admin-panel details').addEventListener('toggle', (e) => {
            document.getElementById('tracker-footer').style.display = e.target.open ? 'none' : '';
        });
    }
    if (location.search.includes('wide')) document.body.classList.add('wide');

    // Zoom controls
    let zoomLevel = 100;
    document.getElementById('zoom-in').addEventListener('click', () => {
        zoomLevel = Math.min(200, zoomLevel + 10);
        document.body.style.zoom = zoomLevel + '%';
    });
    document.getElementById('zoom-out').addEventListener('click', () => {
        zoomLevel = Math.max(50, zoomLevel - 10);
        document.body.style.zoom = zoomLevel + '%';
    });

    // ─── Server Time Sync ────────────────────────────────────────
    let serverTimeOffset = 0;
    db.ref('.info/serverTimeOffset').on('value', (snap) => {
        serverTimeOffset = snap.val() || 0;
    });
    function serverNow() { return Date.now() + serverTimeOffset; }

    // ─── Default data ───────────────────────────────────────────
    const DEFAULTS = {
        config: {
            startingStack: 5000,
            levelDuration: 20,
            tournamentLength: 240,
            smallestChip: 25,
            bonusAmount: 5000,
            rebuyCutoff: 4,
            breakAfterLevel: 0,
            breakDuration: 30,
            startTime: '19:00',
            buyInAmount: 400,
            date: ''
        },
        state: {
            status: 'waiting',   // waiting | running | finished
            startedAt: 0,
            winners: {}       // { "1": "Franta", "2": "Humr", ... }
        },
        players: {
            buyIns: 6,
            activePlayers: 6,
            rebuys: 0,
            bonuses: 0,
            totalChips: 0
        },
        blindStructure: [],
        notes: [
            'Buy-in a re-buy neomezeně, ale jen do konce přestávky',
            'Nepřítomným hráčům se automaticky platí blindy a foldují karty',
            'Kouřit choďte po jednom, ať zbytek stolu může hrát'
        ]
    };

    // Local mirror
    let T = JSON.parse(JSON.stringify(DEFAULTS));
    T.notes = DEFAULTS.notes.slice();

    // ─── Blind Calculation ──────────────────────────────────────
    function roundToChip(val, chip) {
        let unit;
        if (val >= 1000) unit = 100;
        else if (val >= 100) unit = 25;
        else unit = 5;
        return Math.max(chip, Math.round(val / unit) * unit);
    }

    function calculateBlinds(config, totalChips, freezeUpTo) {
        const { levelDuration, tournamentLength, smallestChip } = config;
        const breakAfter = config.breakAfterLevel || 0;
        const breakDur = config.breakDuration || 30;
        const hasBreak = breakAfter > 0;

        // Subtract break from playing time before computing number of blind levels
        const playingTime = hasBreak ? tournamentLength - breakDur : tournamentLength;
        const numLevels = Math.max(2, Math.floor(playingTime / levelDuration));
        const finalBigBlind = roundToChip(totalChips / 3, smallestChip);
        const finalSmall = finalBigBlind / 2;
        const startSmall = smallestChip;

        const levels = [];

        if (freezeUpTo >= 0 && T.blindStructure && T.blindStructure.length > 0) {
            // Freeze existing entries up to and including freezeUpTo (skip breaks from count)
            const frozen = Math.min(freezeUpTo + 1, T.blindStructure.length);
            for (let i = 0; i < frozen; i++) {
                levels.push({ ...T.blindStructure[i] });
            }

            // Count only real blind levels among frozen entries
            const frozenBlindCount = levels.filter(l => !l.isBreak).length;
            const remaining = numLevels - frozenBlindCount;

            if (remaining > 0) {
                // Find last real blind level for progression base
                const lastBlind = [...levels].reverse().find(l => !l.isBreak);
                const currentSmall = lastBlind ? lastBlind.small : smallestChip;
                const newFinalSmall = Math.max(currentSmall, roundToChip(totalChips / 6, smallestChip));
                const ratio = remaining > 1
                    ? Math.pow(newFinalSmall / currentSmall, 1 / (remaining - 1))
                    : 1;

                for (let i = 0; i < remaining; i++) {
                    const small = i === remaining - 1
                        ? newFinalSmall
                        : roundToChip(currentSmall * Math.pow(ratio, i + 1), smallestChip);
                    const big = small * 2;
                    levels.push({ small, big, duration: levelDuration });
                }
            }
        } else {
            // Fresh calculation
            const ratio = numLevels > 1
                ? Math.pow(finalSmall / startSmall, 1 / (numLevels - 1))
                : 1;

            for (let i = 0; i < numLevels; i++) {
                const small = i === 0
                    ? startSmall
                    : (i === numLevels - 1
                        ? roundToChip(finalSmall, smallestChip)
                        : roundToChip(startSmall * Math.pow(ratio, i), smallestChip));
                const big = small * 2;
                levels.push({ small, big, duration: levelDuration });
            }
        }

        // Insert break as its own level after the configured blind level
        // Skip if frozen levels already contain a break
        const alreadyHasBreak = levels.some(l => l.isBreak);
        if (hasBreak && !alreadyHasBreak && breakAfter <= levels.length) {
            levels.splice(breakAfter, 0, {
                small: 0, big: 0,
                duration: breakDur,
                isBreak: true
            });
        }

        return levels;
    }

    function recalcTotalChips() {
        const p = T.players;
        const c = T.config;
        return (p.buyIns + p.rebuys) * c.startingStack + p.bonuses * c.bonusAmount;
    }

    // ─── Derived State ─────────────────────────────────────────
    function getCurrentLevel(startedAt, blindStructure) {
        const struct = blindStructure || [];
        if (!struct.length) return { levelIndex: 0, remaining: 0 };

        const elapsed = serverNow() - startedAt;
        let cumulative = 0;
        for (let i = 0; i < struct.length; i++) {
            const levelMs = struct[i].duration * 60000;
            if (elapsed < cumulative + levelMs) {
                return { levelIndex: i, remaining: cumulative + levelMs - elapsed };
            }
            cumulative += levelMs;
        }
        // Past all levels — stay on last level at 00:00
        return { levelIndex: struct.length - 1, remaining: 0 };
    }

    // ─── Payout Calculation ──────────────────────────────────────
    const PAYOUT_STRUCTURES = {
        1: [100],
        2: [65, 35],
        3: [50, 30, 20]
    };

    function getPayoutDistribution(paidPlaces) {
        if (paidPlaces <= 0) return [];
        if (PAYOUT_STRUCTURES[paidPlaces]) return PAYOUT_STRUCTURES[paidPlaces];
        // 4+ spots: 1st=40%, 2nd=25%, 3rd=18%, rest split evenly
        const remaining = 17;
        const extraPlaces = paidPlaces - 3;
        const perExtra = Math.round(remaining / extraPlaces * 10) / 10;
        const dist = [40, 25, 18];
        for (let i = 0; i < extraPlaces; i++) dist.push(perExtra);
        return dist;
    }

    function renderPayout() {
        const { players, config, state } = T;
        const buyIns = players.buyIns || 0;
        const rebuys = players.rebuys || 0;
        const activePlayers = players.activePlayers || 0;
        const buyInAmount = config.buyInAmount || 400;

        const prizePool = (buyIns + rebuys) * buyInAmount;
        const paidPlaces = Math.max(1, Math.floor(buyIns * 0.25));
        const dist = getPayoutDistribution(paidPlaces);

        document.getElementById('hd-pool').textContent = prizePool.toLocaleString('cs') + ' Kč';
        document.getElementById('hd-places').textContent = paidPlaces;
        document.getElementById('hd-places-label').textContent =
            paidPlaces === 1 ? 'vítěz' : paidPlaces <= 4 ? 'výherci' : 'výherců';


        const tbody = document.getElementById('payout-body');
        tbody.innerHTML = '';
        dist.forEach((pct, i) => {
            const tr = document.createElement('tr');
            const amount = Math.round(prizePool * pct / 100);
            tr.innerHTML =
                '<td>' + (i + 1) + '.</td>' +
                '<td>' + pct + '%</td>' +
                '<td>' + amount.toLocaleString('cs') + ' Kč</td>';
            tbody.appendChild(tr);
        });

    }

    function recalcAndSync() {
        const totalChips = recalcTotalChips();
        let freezeUpTo = -1;
        if (T.state.status === 'running' && T.state.startedAt) {
            freezeUpTo = getCurrentLevel(T.state.startedAt, T.blindStructure).levelIndex;
        }
        const structure = calculateBlinds(T.config, totalChips, freezeUpTo);

        tournamentRef.child('players/totalChips').set(totalChips);
        tournamentRef.child('blindStructure').set(structure);
    }

    // ─── Rendering ──────────────────────────────────────────────
    function formatTime(ms) {
        if (ms <= 0) return '00:00';
        const totalSec = Math.ceil(ms / 1000);
        const m = Math.floor(totalSec / 60);
        const s = totalSec % 60;
        return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    function render() {
        const { config, state, players, blindStructure } = T;

        // Header stats
        document.getElementById('hd-active').textContent = players.activePlayers;
        document.getElementById('hd-buyin').textContent = players.buyIns;
        document.getElementById('hd-chips').textContent = players.totalChips.toLocaleString('cs');
        document.getElementById('hd-buyin-amount').textContent = (config.buyInAmount || 400).toLocaleString('cs') + ' Kč';

        // Start time in header
        const hdStartItem = document.getElementById('hd-start-item');
        if (state.startedAt && state.status === 'running') {
            const d = new Date(state.startedAt);
            const hh = String(d.getHours()).padStart(2, '0');
            const mm = String(d.getMinutes()).padStart(2, '0');
            document.getElementById('hd-start').textContent = hh + ':' + mm;
            hdStartItem.style.display = '';
        } else {
            hdStartItem.style.display = 'none';
        }

        // Admin start time input (show when running, keep in sync)
        if (isAdmin) {
            const startTimeRow = document.getElementById('start-time-row');
            const startTimeInput = document.getElementById('cfg-start-time');
            if (state.status === 'running' && state.startedAt) {
                startTimeRow.style.display = '';
                if (document.activeElement !== startTimeInput) {
                    const d = new Date(state.startedAt);
                    const hh = String(d.getHours()).padStart(2, '0');
                    const mm = String(d.getMinutes()).padStart(2, '0');
                    startTimeInput.value = hh + ':' + mm;
                }
            } else {
                startTimeRow.style.display = 'none';
            }
        }

        // Admin player counts — now handled by config input sync below

        // Winners logic
        const winners = state.winners || {};
        const winnerEntries = Object.keys(winners).filter(k => winners[k]).sort((a, b) => a - b);
        const buyIns = players.buyIns || 0;
        const paidPlaces = Math.max(1, Math.floor(buyIns * 0.25));
        const allDeclared = winnerEntries.length >= paidPlaces && paidPlaces > 0;

        // Winner banner — hide timer/blinds/structure only when all places declared
        const winnerBanner = document.getElementById('winner-banner');
        document.getElementById('display').style.display = allDeclared ? 'none' : '';
        document.querySelector('.structure-wrap').style.display = allDeclared ? 'none' : '';
        if (allDeclared) {
            winnerBanner.style.display = '';
            const listEl = document.getElementById('winner-list');
            listEl.innerHTML = winnerEntries.map(k =>
                '<div class="winner-entry"><span class="place">' + k + '. místo: </span>' +
                '<span class="name">' + winners[k] + '</span></div>'
            ).join('');
            // Stop tournament when all winners declared
            if (state.status === 'running') {
                if (isAdmin) tournamentRef.child('state/status').set('finished');
            }
        } else {
            winnerBanner.style.display = 'none';
        }

        // Current blinds (derived from startedAt)
        const struct = blindStructure || [];
        const derived = (state.status === 'running' && state.startedAt)
            ? getCurrentLevel(state.startedAt, struct)
            : { levelIndex: 0, remaining: 0 };
        const lvl = derived.levelIndex;

        const curEntry = struct[lvl];
        const onBreak = curEntry && curEntry.isBreak;
        const blindsCurEl = document.getElementById('blinds-current');
        const progressBarEl = document.getElementById('progress-bar');

        // Blinds / break display
        const blindsLabelEl = document.getElementById('blinds-label');
        if (onBreak) {
            blindsLabelEl.style.display = 'none';
            blindsCurEl.textContent = 'PŘESTÁVKA';
            blindsCurEl.classList.add('on-break');
            progressBarEl.classList.add('on-break');
            document.getElementById('blinds-sub').textContent =
                curEntry.duration + ' min';
        } else if (curEntry) {
            blindsLabelEl.style.display = '';
            blindsCurEl.textContent =
                curEntry.small.toLocaleString('cs') + ' / ' + curEntry.big.toLocaleString('cs');
            blindsCurEl.classList.remove('on-break');
            progressBarEl.classList.remove('on-break');
            document.getElementById('blinds-sub').textContent = '';
        } else {
            blindsLabelEl.style.display = '';
            blindsCurEl.textContent = '– / –';
            blindsCurEl.classList.remove('on-break');
            progressBarEl.classList.remove('on-break');
            document.getElementById('blinds-sub').textContent = '';
        }

        // Next level preview (skip break entries to show next real level)
        const nextEl = document.getElementById('next-level');
        const nextReal = struct.slice(lvl + 1).find(s => !s.isBreak);
        if (nextReal) {
            nextEl.innerHTML = 'Další blindy: <span>' +
                nextReal.small.toLocaleString('cs') + ' / ' + nextReal.big.toLocaleString('cs') +
                '</span>';
        } else {
            nextEl.textContent = '';
        }

        // Structure table
        const tbody = document.getElementById('structure-body');
        tbody.innerHTML = '';
        // Use actual startedAt timestamp when tournament has started, otherwise config startTime
        let runningMinutes;
        if (state.startedAt) {
            const d = new Date(state.startedAt);
            runningMinutes = d.getHours() * 60 + d.getMinutes();
        } else {
            const startTimeParts = (config.startTime || '19:00').split(':');
            runningMinutes = parseInt(startTimeParts[0]) * 60 + parseInt(startTimeParts[1]);
        }

        let levelNum = 0;
        struct.forEach((s, i) => {
            const tr = document.createElement('tr');
            const classes = [];
            if (i === lvl) classes.push('current-level');
            else if (i < lvl) classes.push('past-level');

            const hh = String(Math.floor(runningMinutes / 60) % 24).padStart(2, '0');
            const mm = String(runningMinutes % 60).padStart(2, '0');
            const timeStr = hh + ':' + mm;

            if (s.isBreak) {
                const endMin = runningMinutes + s.duration;
                const endHH = String(Math.floor(endMin / 60) % 24).padStart(2, '0');
                const endMM = String(endMin % 60).padStart(2, '0');
                classes.push('break-row');
                tr.className = classes.join(' ');
                tr.innerHTML =
                    '<td colspan="4">PŘESTÁVKA ' + timeStr + ' – ' + endHH + ':' + endMM + '</td>';
            } else {
                levelNum++;
                tr.className = classes.join(' ');
                tr.innerHTML =
                    '<td>' + levelNum + '</td>' +
                    '<td>' + timeStr + '</td>' +
                    '<td>' + s.small.toLocaleString('cs') + '</td>' +
                    '<td>' + s.big.toLocaleString('cs') + '</td>';
            }
            runningMinutes += s.duration;
            tbody.appendChild(tr);
        });

        // Ticker (duplicate content for seamless loop)
        const notes = T.notes || [];
        const sep = '\u00A0\u00A0\u00A0\u00A0\u00A0·\u00A0\u00A0\u00A0\u00A0\u00A0';
        const tickerText = notes.length ? notes.join(sep) + sep : '';
        const tickerA = document.getElementById('ticker-a');
        const tickerB = document.getElementById('ticker-b');
        if (tickerA) tickerA.textContent = tickerText;
        if (tickerB) tickerB.textContent = tickerText;

        // Payout (always visible)
        renderPayout();

        // Freeze tournament config when not in waiting state
        if (isAdmin) {
            const frozen = state.status !== 'waiting';
            document.getElementById('section-config').classList.toggle('frozen', frozen);
        }

        // Populate config + player inputs from current data
        if (isAdmin) {
            const ids = {
                'cfg-stack': config.startingStack,
                'cfg-level-dur': config.levelDuration,
                'cfg-tourney-len': config.tournamentLength,
                'cfg-smallest': config.smallestChip,
                'cfg-bonus': config.bonusAmount,
                'cfg-rebuy-cutoff': config.rebuyCutoff,
                'cfg-break-after': config.breakAfterLevel,
                'cfg-break-dur': config.breakDuration,
                'cfg-buyin-amount': config.buyInAmount,
                'cfg-buyins': players.buyIns,
                'cfg-active': players.activePlayers,
                'cfg-rebuys': players.rebuys,
                'cfg-bonuses': players.bonuses
            };
            for (const [id, val] of Object.entries(ids)) {
                const el = document.getElementById(id);
                if (el && document.activeElement !== el) el.value = val;
            }

            // Generate winner input fields for each paid place
            const wf = document.getElementById('winners-fields');
            const currentFields = wf.querySelectorAll('input');
            const hasFocus = Array.from(currentFields).some(el => el === document.activeElement);
            if (!hasFocus || currentFields.length !== paidPlaces) {
                const html = [];
                for (let i = 1; i <= paidPlaces; i++) {
                    html.push(
                        '<div class="config-field" style="margin-bottom:6px">' +
                        '<label>' + i + '. místo</label>' +
                        '<input type="text" id="cfg-winner-' + i + '" placeholder="Jméno hráče..." value="' +
                        ((winners[i] || '').replace(/"/g, '&quot;')) + '">' +
                        '</div>'
                    );
                }
                wf.innerHTML = html.join('');
            }

            // Sync note inputs (only if not editing)
            const noteInputs = document.querySelectorAll('#notes-list input');
            const noteHasFocus = Array.from(noteInputs).some(el => el === document.activeElement);
            if (!noteHasFocus && typeof renderNoteInputs === 'function') {
                renderNoteInputs();
            }
        }
    }

    // ─── Timer Loop ─────────────────────────────────────────────
    let prevLevel = -1;
    let timerInterval = null;

    function startTimerLoop() {
        if (timerInterval) return;
        timerInterval = setInterval(tickTimer, 100);
    }

    function tickTimer() {
        const { state, blindStructure } = T;
        const struct = blindStructure || [];
        const timerEl = document.getElementById('timer');
        const progressEl = document.getElementById('progress-bar');

        if (state.status === 'running' && state.startedAt) {
            const derived = getCurrentLevel(state.startedAt, struct);

            timerEl.textContent = formatTime(derived.remaining);
            timerEl.classList.toggle('warning', derived.remaining <= 30000 && derived.remaining > 0);

            // Progress bar
            const duration = (struct[derived.levelIndex]?.duration || 20) * 60000;
            const elapsed = duration - derived.remaining;
            const pct = Math.min(100, Math.max(0, (elapsed / duration) * 100));
            progressEl.style.width = pct + '%';

            // Level-change sound + re-render blinds display
            if (prevLevel >= 0 && derived.levelIndex !== prevLevel) {
                playLevelSound();
                render();
            }
            prevLevel = derived.levelIndex;
        } else {
            // Waiting or finished — show first level's duration as idle timer
            const duration = (struct[0]?.duration || 20) * 60000;
            timerEl.textContent = formatTime(duration);
            timerEl.classList.remove('warning');
            progressEl.style.width = '0%';
        }
    }

    startTimerLoop();

    // ─── Level Change Sound ─────────────────────────────────────
    const levelSound = new Audio('../assets/whistle.wav');
    function playLevelSound() {
        levelSound.currentTime = 0;
        levelSound.play().catch(() => {});
    }

    document.getElementById('btn-test-sound').addEventListener('click', playLevelSound);

    // ─── Firebase Listener ──────────────────────────────────────
    tournamentRef.on('value', (snap) => {
        const data = snap.val();
        if (!data) {
            // Initialize with defaults
            if (isAdmin) {
                tournamentRef.set(DEFAULTS);
            }
            return;
        }

        T.config = { ...DEFAULTS.config, ...data.config };
        T.state = { ...DEFAULTS.state, ...data.state };

        // Migrate old "count" field to "buyIns" / "activePlayers"
        const rawPlayers = data.players || {};
        if (rawPlayers.count !== undefined && rawPlayers.buyIns === undefined) {
            rawPlayers.buyIns = rawPlayers.count;
            rawPlayers.activePlayers = rawPlayers.count;
            delete rawPlayers.count;
        }
        T.players = { ...DEFAULTS.players, ...rawPlayers };
        T.blindStructure = data.blindStructure || [];
        T.notes = data.notes || DEFAULTS.notes;

        render();
    });

    // ─── Admin Actions ──────────────────────────────────────────
    if (isAdmin) {
        // Save tournament config (only possible in waiting state)
        document.getElementById('btn-save-config').addEventListener('click', () => {
            if (T.state.status !== 'waiting') return;
            const config = {
                startingStack: parseInt(document.getElementById('cfg-stack').value) || 5000,
                levelDuration: parseInt(document.getElementById('cfg-level-dur').value) || 20,
                tournamentLength: parseInt(document.getElementById('cfg-tourney-len').value) || 240,
                smallestChip: parseInt(document.getElementById('cfg-smallest').value) || 25,
                bonusAmount: parseInt(document.getElementById('cfg-bonus').value) || 5000,
                rebuyCutoff: parseInt(document.getElementById('cfg-rebuy-cutoff').value) || 4,
                breakAfterLevel: parseInt(document.getElementById('cfg-break-after').value) || 0,
                breakDuration: parseInt(document.getElementById('cfg-break-dur').value) || 30,
                buyInAmount: parseInt(document.getElementById('cfg-buyin-amount').value) || 400
            };

            tournamentRef.child('config').set(config).then(() => {
                T.config = config;
                recalcAndSync();
                const btn = document.getElementById('btn-save-config');
                btn.textContent = 'Nastavení uloženo ✓';
                setTimeout(() => { btn.textContent = 'Uložit nastavení'; }, 2000);
            });
        });

        // Auto-save player fields on change (debounced)
        let playerSaveTimer = null;
        let playerStatusTimer = null;
        function showPlayerStatus(text) {
            const el = document.getElementById('player-save-status');
            clearTimeout(playerStatusTimer);
            el.textContent = text;
            if (text.includes('✓')) {
                playerStatusTimer = setTimeout(() => { el.textContent = ''; }, 2000);
            }
        }
        function autoSavePlayers() {
            clearTimeout(playerSaveTimer);
            showPlayerStatus('Ukládám…');
            playerSaveTimer = setTimeout(() => {
                const playerData = {
                    buyIns: parseInt(document.getElementById('cfg-buyins').value) || 0,
                    activePlayers: parseInt(document.getElementById('cfg-active').value) || 0,
                    rebuys: parseInt(document.getElementById('cfg-rebuys').value) || 0,
                    bonuses: parseInt(document.getElementById('cfg-bonuses').value) || 0
                };
                tournamentRef.child('players').update(playerData).then(() => {
                    T.players = { ...T.players, ...playerData };
                    recalcAndSync();
                    showPlayerStatus('Uloženo ✓');
                });
            }, 800);
        }
        ['cfg-buyins', 'cfg-active', 'cfg-rebuys', 'cfg-bonuses'].forEach(id => {
            document.getElementById(id).addEventListener('input', autoSavePlayers);
        });

        // Quick-action player buttons (increment + auto-save)
        function getField(id) { return parseInt(document.getElementById(id).value) || 0; }

        document.getElementById('btn-add-player').addEventListener('click', () => {
            const updates = {};
            updates['players/buyIns'] = getField('cfg-buyins') + 1;
            updates['players/activePlayers'] = getField('cfg-active') + 1;
            tournamentRef.update(updates).then(() => { recalcAndSync(); showPlayerStatus('Uloženo ✓'); });
        });

        document.getElementById('btn-rebuy').addEventListener('click', () => {
            const updates = {};
            updates['players/rebuys'] = getField('cfg-rebuys') + 1;
            tournamentRef.update(updates).then(() => { recalcAndSync(); showPlayerStatus('Uloženo ✓'); });
        });

        document.getElementById('btn-bonus').addEventListener('click', () => {
            tournamentRef.child('players/bonuses').set(getField('cfg-bonuses') + 1).then(() => { recalcAndSync(); showPlayerStatus('Uloženo ✓'); });
        });

        document.getElementById('btn-knockout').addEventListener('click', () => {
            const active = getField('cfg-active');
            if (active <= 0) return;
            tournamentRef.child('players/activePlayers').set(active - 1).then(() => showPlayerStatus('Uloženo ✓'));
        });

        // Save winners
        document.getElementById('btn-save-winners').addEventListener('click', () => {
            const winners = {};
            const buyIns = T.players.buyIns || 0;
            const paidPlaces = Math.max(1, Math.floor(buyIns * 0.25));
            for (let i = 1; i <= paidPlaces; i++) {
                const el = document.getElementById('cfg-winner-' + i);
                const name = el ? el.value.trim() : '';
                if (name) winners[i] = name;
            }
            tournamentRef.child('state/winners').set(winners).then(() => {
                const btn = document.getElementById('btn-save-winners');
                btn.textContent = 'Výsledky uloženy ✓';
                setTimeout(() => { btn.textContent = 'Uložit výsledky'; }, 2000);
            });
        });

        // Timer controls
        document.getElementById('btn-start').addEventListener('click', () => {
            if (T.state.status === 'running') return;
            if (!confirm('Spustit timer?')) return;
            tournamentRef.child('state').update({
                status: 'running',
                startedAt: serverNow()
            });
        });

        document.getElementById('btn-set-start-time').addEventListener('click', () => {
            const val = document.getElementById('cfg-start-time').value;
            if (!val) return;
            const [hh, mm] = val.split(':').map(Number);
            const d = new Date(T.state.startedAt);
            d.setHours(hh, mm, 0, 0);
            tournamentRef.child('state/startedAt').set(d.getTime());
        });

        document.getElementById('btn-reset').addEventListener('click', () => {
            if (!confirm('Opravdu resetovat celý turnaj?')) return;
            tournamentRef.child('state').set(DEFAULTS.state);
            tournamentRef.child('players').set(DEFAULTS.players);
            recalcAndSync();
        });

        // Notes (ticker)
        function renderNoteInputs() {
            const list = document.getElementById('notes-list');
            const notes = T.notes || [];
            list.innerHTML = notes.map((note, i) =>
                '<div class="note-row">' +
                '<input type="text" value="' + note.replace(/"/g, '&quot;') + '" data-note-idx="' + i + '">' +
                '<button class="btn-remove-note" data-note-idx="' + i + '">&times;</button>' +
                '</div>'
            ).join('');
        }

        renderNoteInputs();

        document.getElementById('notes-list').addEventListener('click', (e) => {
            if (!e.target.classList.contains('btn-remove-note')) return;
            const idx = parseInt(e.target.dataset.noteIdx);
            T.notes.splice(idx, 1);
            renderNoteInputs();
        });

        document.getElementById('btn-add-note').addEventListener('click', () => {
            T.notes = T.notes || [];
            T.notes.push('');
            renderNoteInputs();
            const inputs = document.querySelectorAll('#notes-list input');
            if (inputs.length) inputs[inputs.length - 1].focus();
        });

        document.getElementById('btn-save-notes').addEventListener('click', () => {
            const inputs = document.querySelectorAll('#notes-list input');
            const notes = Array.from(inputs).map(el => el.value.trim()).filter(Boolean);
            tournamentRef.child('notes').set(notes).then(() => {
                const btn = document.getElementById('btn-save-notes');
                btn.textContent = 'Poznámky uloženy ✓';
                setTimeout(() => { btn.textContent = 'Uložit poznámky'; }, 2000);
            });
        });
    }
    </script>
</body>
</html>
