<!DOCTYPE html>
<html lang="en">
<head>
    <title>Poker Winnings Graph</title>
    <script src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        html, body {
            height: auto;
            overflow: hidden;
            background: #181818;
            margin: 0;
        }
        #chartDiv {
            width: 100%;
            max-width: 1200px;
            min-width: 400px;
            height: 420px;
            margin: 0 auto;
        }
        @media (max-width: 700px) {
            #chartDiv {
                min-width: 400px;
                width: 100vw;
            }
        }
        #loadingSpinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            min-height: 200px;
            width: 100%;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 10;
            background: none;
        }
        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #4E79A7;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .google-visualization-tooltip {
            background: #222 !important;
            border: 1px solid #444 !important;
            border-radius: 6px !important;
            padding: 0 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5) !important;
            pointer-events: none;
        }
        .tt {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 12px;
            color: #ddd;
            padding: 8px 12px;
            min-width: 180px;
        }
        .tt-header {
            font-weight: bold;
            color: #fff;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #444;
        }
        .tt-row {
            display: flex;
            align-items: center;
            padding: 2px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .tt-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .tt-name {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tt-val {
            margin-left: 8px;
            white-space: nowrap;
        }
        .tt-delta {
            margin-left: 6px;
            white-space: nowrap;
            color: #888;
        }
        .tt-delta.pos { color: #4ade80; }
        .tt-delta.neg { color: #f87171; }
        #playerTotalsList {
            margin: 20px auto;
            max-width: 300px;
            padding: 0 16px 30px 16px;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        .player-total-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
            font-size: 0.85em;
            color: white;
        }
        .player-color-circle {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
        }
        .player-name {
            flex: 1;
            min-width: 0;
            color: white;
            text-shadow: 1px 1px 2px black;
        }
        .player-total {
            font-weight: bold;
            margin-left: 12px;
            white-space: nowrap;
        }
        .player-total.positive {
            color: #059669;
        }
        .player-total.negative {
            color: #dc2626;
        }
    </style>
</head>
<body>
<div id="playerFilterContainer" style="margin: 12px 0 0 0; text-align:center;"></div>
<div id="loadingSpinner">
    <div class="spinner"></div>
</div>
<div id="chartDiv" style="visibility:hidden;"></div>
<div id="playerTotalsList"></div>
<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTAYSlBiWTAJ_th0XEzDk9fthNQBrF88_FdBry3l8l9IrcGuopvFoBzIY4Byb5yfTE0U-LyqGkmZxkX/pub?gid=0&single=true&output=csv';
    const PLAYER_MIN_SESSIONS = 2;
    const COLORS = [
        "#E15759", "#4E79A7", "#F28E2B", "#76B7B2", "#59A14F", "#EDC948",
        "#B07AA1", "#FF9DA7", "#9C755F", "#BAB0AC", "#1F77B4", "#AEC7E8",
        "#FF7F0E", "#FFBB78", "#2CA02C", "#98DF8A", "#D62728", "#FF9896",
        "#9467BD", "#C5B0D5", "#8C564B", "#C49C94", "#E377C2", "#F7B6D2",
        "#7F7F7F", "#C7C7C7", "#BCBD22", "#DBDB8D", "#17BECF", "#9EDAE5",
        "#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252",
        "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94",
        "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194",
        "#ce6dbd", "#de9ed6", "#1b9e77", "#d95f02"
    ];

    let chart = null;
    let chartData = null;
    let playerNames = [];
    let playerColors = {};
    let selectedPlayer = '';

    const CACHE_KEY = 'smelo_graph_csv';
    const CACHE_TS_KEY = 'smelo_graph_csv_ts';
    const CACHE_TTL = 60 * 60 * 1000; // 1 hour

    function fetchCSV() {
        const cached = localStorage.getItem(CACHE_KEY);
        const cachedTs = localStorage.getItem(CACHE_TS_KEY);
        if (cached && cachedTs && (Date.now() - Number(cachedTs)) < CACHE_TTL) {
            return Promise.resolve(cached);
        }
        return fetch(SHEET_URL).then(r => r.text()).then(csv => {
            try {
                localStorage.setItem(CACHE_KEY, csv);
                localStorage.setItem(CACHE_TS_KEY, String(Date.now()));
            } catch (e) { /* ignore quota errors */ }
            return csv;
        });
    }

    google.charts.load('current', { packages: ['corechart'] });
    google.charts.setOnLoadCallback(fetchAndRender);

    function fetchAndRender() {
        fetchCSV().then(csv => {
                const lines = csv.trim().split('\n');
                const headers = lines[0].split(',');
                const allDataRows = lines.slice(2).map(line => line.split(','));

                // Parse dates
                const allRowsWithDate = allDataRows
                    .filter(row => row[1] && row[1].trim() !== '')
                    .map(row => {
                        const raw = row[1].trim();
                        let ts = Date.parse(raw);
                        if (isNaN(ts)) {
                            let m = raw.match(/(\d{4}-\d{2}-\d{2})/);
                            if (m) ts = Date.parse(m[1]);
                            else {
                                m = raw.match(/(\d{1,2}\.\d{1,2}\.\d{4})/);
                                if (m) {
                                    const parts = m[1].split('.');
                                    ts = Date.parse(`${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`);
                                } else {
                                    m = raw.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);
                                    if (m) {
                                        const parts = m[1].split('/');
                                        ts = Date.parse(`${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`);
                                    } else {
                                        ts = NaN;
                                    }
                                }
                            }
                        }
                        return { row, date: isNaN(ts) ? null : new Date(ts) };
                    });

                const yearAgo = new Date();
                yearAgo.setMonth(yearAgo.getMonth() - 6);

                // Filter valid columns (non-empty headers)
                const validColumns = headers.map((h, i) => ({ h, i })).filter(x => x.h && x.h.trim() !== '');

                // Count appearances in last year
                const rowsLastYear = allRowsWithDate.filter(x => x.date && x.date >= yearAgo).map(x => x.row);
                const playerAppearances = validColumns.map(x => {
                    let count = 0;
                    for (const row of rowsLastYear) {
                        const val = row[x.i];
                        if (val !== undefined && val !== '' && val !== '0' && Number(val) !== 0) count++;
                    }
                    return count;
                });

                const filteredColumns = validColumns.filter((_, idx) => playerAppearances[idx] >= PLAYER_MIN_SESSIONS);
                playerNames = filteredColumns.map(x => x.h);

                // Assign colors
                playerNames.forEach((name, i) => {
                    playerColors[name] = COLORS[i % COLORS.length];
                });

                // Calculate cumulative from ALL rows
                const allWinnings = allRowsWithDate.map(x => filteredColumns.map(col => x.row[col.i] === '' ? 0 : Number(x.row[col.i])));
                const allOriginalCells = allRowsWithDate.map(x => filteredColumns.map(col => x.row[col.i]));

                const allCumulative = playerNames.map((_, colIdx) => {
                    let sum = 0;
                    return allWinnings.map(row => sum += (row[colIdx] || 0));
                });

                // Find cutoff index
                let cutoffIndex = 0;
                for (let i = 0; i < allRowsWithDate.length; i++) {
                    if (allRowsWithDate[i].date && allRowsWithDate[i].date >= yearAgo) {
                        cutoffIndex = i;
                        break;
                    }
                }

                // Extract display window
                const rows = allRowsWithDate.slice(cutoffIndex);
                const cumulative = allCumulative.map(arr => arr.slice(cutoffIndex));
                const originalCells = allOriginalCells.slice(cutoffIndex);

                // Null-trailing: set values after last active session to null
                cumulative.forEach((arr, colIdx) => {
                    let lastIdx = -1;
                    for (let i = arr.length - 1; i >= 0; i--) {
                        const cell = originalCells[i][colIdx];
                        if (cell !== undefined && cell !== '' && cell !== '0' && Number(cell) !== 0) {
                            lastIdx = i;
                            break;
                        }
                    }
                    if (lastIdx >= 0 && lastIdx < arr.length - 1) {
                        for (let i = lastIdx + 1; i < arr.length; i++) arr[i] = null;
                    }
                });

                // Null-leading: set values before first non-null non-zero to null
                cumulative.forEach((arr, colIdx) => {
                    let firstIdx = -1;
                    for (let i = 0; i < arr.length; i++) {
                        if (arr[i] != null && arr[i] !== 0) { firstIdx = i; break; }
                    }
                    if (firstIdx > 0) {
                        for (let i = 0; i < firstIdx; i++) arr[i] = null;
                    }
                });

                // Session labels (Czech day names)
                const sessionLabels = rows.map(x => x.row[1]
                    .replace(/Mon/g, 'Po').replace(/Tue/g, 'Út').replace(/Wed/g, 'St')
                    .replace(/Thu/g, 'Čt').replace(/Fri/g, 'Pá').replace(/Sat/g, 'So')
                    .replace(/Sun/g, 'Ne')
                );

                // Build tooltip HTML for a given row index — only players who played that session
                function buildTooltip(rowIdx) {
                    const date = sessionLabels[rowIdx];
                    const entries = playerNames.map((name, colIdx) => {
                        const cell = originalCells[rowIdx][colIdx];
                        const delta = (cell !== undefined && cell !== '' && cell !== '0') ? Number(cell) : 0;
                        if (delta === 0) return null;
                        const val = cumulative[colIdx][rowIdx];
                        return { name: name.split('/')[0].trim(), val, delta, color: playerColors[name] };
                    }).filter(Boolean).sort((a, b) => b.delta - a.delta);

                    let html = `<div class="tt"><div class="tt-header">${date}</div>`;
                    entries.forEach(e => {
                        const sign = e.delta > 0 ? '+' : '';
                        const deltaClass = e.delta > 0 ? 'pos' : e.delta < 0 ? 'neg' : '';
                        html += `<div class="tt-row">` +
                            `<span class="tt-dot" style="background:${e.color}"></span>` +
                            `<span class="tt-name">${e.name}</span>` +
                            `<span class="tt-val">${e.val}</span>` +
                            `<span class="tt-delta ${deltaClass}">(${sign}${e.delta})</span>` +
                            `</div>`;
                    });
                    html += '</div>';
                    return html;
                }

                // Build Google Charts DataTable
                // Each data column gets a tooltip column with the same shared HTML
                chartData = new google.visualization.DataTable();
                chartData.addColumn('string', 'Datum');
                playerNames.forEach(name => {
                    chartData.addColumn('number', name);
                    chartData.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });
                });

                for (let i = 0; i < sessionLabels.length; i++) {
                    const tooltip = buildTooltip(i);
                    const row = [sessionLabels[i]];
                    playerNames.forEach((_, colIdx) => {
                        row.push(cumulative[colIdx][i]);
                        row.push(tooltip);
                    });
                    chartData.addRow(row);
                }

                renderPlayerFilter();
                renderPlayerTotals(cumulative);
                drawChart();

                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('chartDiv').style.visibility = 'visible';
            });
    }

    function renderPlayerFilter() {
        const container = document.getElementById('playerFilterContainer');
        container.innerHTML = '';
        const select = document.createElement('select');
        select.style.fontSize = '1.1em';
        select.style.padding = '2px 8px';
        select.id = 'playerFilterSelect';

        const allOption = document.createElement('option');
        allOption.value = '';
        allOption.textContent = 'Všichni';
        select.appendChild(allOption);

        const sorted = [...playerNames].sort((a, b) => a.localeCompare(b, 'cs', { sensitivity: 'base' }));
        sorted.forEach(player => {
            const opt = document.createElement('option');
            opt.value = player;
            opt.textContent = player.split('/')[0].trim();
            select.appendChild(opt);
        });

        container.appendChild(select);
        select.addEventListener('change', () => {
            selectedPlayer = select.value;
            drawChart();
        });
    }

    function drawChart() {
        if (!chartData) return;

        const series = {};
        playerNames.forEach((name, i) => {
            const color = playerColors[name];
            if (selectedPlayer && name !== selectedPlayer) {
                series[i] = {
                    color: '#555',
                    lineWidth: 1,
                    pointSize: 0,
                    visibleInLegend: false
                };
            } else if (selectedPlayer && name === selectedPlayer) {
                series[i] = {
                    color: color,
                    lineWidth: 3,
                    pointSize: 4,
                    visibleInLegend: true
                };
            } else {
                series[i] = {
                    color: color,
                    lineWidth: 2,
                    pointSize: 0,
                    visibleInLegend: true
                };
            }
        });

        const options = {
            title: 'Kumulativní šmelo',
            titleTextStyle: { fontSize: 14, color: '#eee' },
            curveType: 'function',
            legend: 'none',
            interpolateNulls: false,
            dataOpacity: 0.7,
            series: series,
            hAxis: {
                title: 'Datum pošmelení',
                titleTextStyle: { color: '#aaa', italic: false },
                textStyle: { fontSize: 10, color: '#aaa' },
                slantedText: true,
                slantedTextAngle: 45,
                gridlines: { color: '#333' },
                baselineColor: '#444'
            },
            vAxis: {
                title: 'pošmel / výšmel',
                titleTextStyle: { color: '#aaa', italic: false },
                textStyle: { color: '#aaa' },
                gridlines: { color: '#333' },
                baselineColor: '#444',
                format: 'short'
            },
            chartArea: {
                left: 60,
                top: 40,
                right: 20,
                bottom: 80,
                width: '100%',
                height: '100%',
                backgroundColor: 'transparent'
            },
            tooltip: {
                isHtml: true,
                trigger: 'both'
            },
            explorer: {
                actions: ['dragToZoom', 'rightClickToReset'],
                axis: 'horizontal',
                keepInBounds: true,
                maxZoomIn: 0.1
            },
            backgroundColor: 'transparent'
        };

        if (!chart) {
            chart = new google.visualization.LineChart(document.getElementById('chartDiv'));
        }
        chart.draw(chartData, options);
    }

    function renderPlayerTotals(cumulative) {
        const container = document.getElementById('playerTotalsList');
        container.innerHTML = '';

        const playerTotals = playerNames.map((name, i) => {
            let lastTotal = 0;
            for (let j = cumulative[i].length - 1; j >= 0; j--) {
                if (cumulative[i][j] != null) { lastTotal = cumulative[i][j]; break; }
            }
            return {
                name: name.split('/')[0].trim(),
                total: lastTotal,
                color: playerColors[name]
            };
        });

        playerTotals.sort((a, b) => b.total - a.total);

        playerTotals.forEach(player => {
            const item = document.createElement('div');
            item.className = 'player-total-item';

            const circle = document.createElement('div');
            circle.className = 'player-color-circle';
            circle.style.backgroundColor = player.color;

            const name = document.createElement('div');
            name.className = 'player-name';
            name.textContent = player.name;

            const total = document.createElement('div');
            total.className = 'player-total';
            if (player.total > 0) {
                total.classList.add('positive');
                total.textContent = `+${player.total}`;
            } else if (player.total < 0) {
                total.classList.add('negative');
                total.textContent = player.total;
            } else {
                total.textContent = '0';
            }

            item.appendChild(circle);
            item.appendChild(name);
            item.appendChild(total);
            container.appendChild(item);
        });
    }

    // Redraw on resize
    window.addEventListener('resize', () => { if (chart && chartData) drawChart(); });
</script>
</body>
</html>
